# ä»£ç è´¨é‡æå‡æ–¹æ¡ˆ

## ğŸ”´ ä¸¥é‡ä»£ç é—®é¢˜

### é—®é¢˜ 1ï¼šç¡¬ç¼–ç çš„é…ç½®

#### å½“å‰ä»£ç 
```typescript
// âŒ ç¡¬ç¼–ç å¹´ä»½å’Œç§‘ç›®
const years = [2024, 2023, 2022, 2021];
const subjects = [
  "ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½",
  "ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰",
  "ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰",
  "è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰"
];
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šé…ç½®æ–‡ä»¶

```typescript
// config/exam.config.ts
export const EXAM_CONFIG = {
  pharmacist: {
    name: 'æ‰§ä¸šè¯å¸ˆ',
    years: [2024, 2023, 2022, 2021],
    subjects: [
      { id: 'zhongyao-zonghe', name: 'ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½', abbr: 'ä¸­ç»¼' },
      { id: 'zhongyao-yiyao', name: 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰', abbr: 'ä¸­ä¸€' },
      { id: 'zhongyao-eryao', name: 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰', abbr: 'ä¸­äºŒ' },
      { id: 'yaoxue-yiyao', name: 'è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰', abbr: 'è¯ä¸€' },
    ],
    passingScore: 72,
    totalScore: 120,
  },
  // æ‰©å±•å…¶ä»–è€ƒè¯•ç±»å‹
  tcm: {
    name: 'ä¸­åŒ»å¸ˆ',
    // ...
  }
} as const;

// ä½¿ç”¨é…ç½®
import { EXAM_CONFIG } from '@/config/exam.config';

const config = EXAM_CONFIG[examType as keyof typeof EXAM_CONFIG];
const years = config.years;
const subjects = config.subjects;
```

### é—®é¢˜ 2ï¼šç±»å‹å®‰å…¨ä¸è¶³

#### å½“å‰ä»£ç 
```typescript
// âŒ anyç±»å‹
const where: any = {
  is_published: true,
};

// âŒ é­”æ³•å­—ç¬¦ä¸²
if (mode === "random") { ... }
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šä¸¥æ ¼ç±»å‹

```typescript
// types/question.types.ts
export type QuestionMode = 'chapter' | 'random' | 'mistake' | 'favorite';
export type QuestionType = 'single' | 'multiple' | 'matching' | 'comprehensive';
export type ExamType = 'pharmacist' | 'tcm' | 'nurse';

export interface QuestionFilter {
  exam_type?: ExamType;
  subject?: string;
  chapter?: string;
  source_year?: number;
  is_published: boolean;
}

export interface YearData {
  year: number;
  totalQuestions: number;
  completedQuestions: number;
  correctRate: number;
  subjects: SubjectInfo[];
  status: YearStatus;
}

export type YearStatus = 'pending' | 'available' | 'in-progress' | 'completed';

// ä½¿ç”¨ä¸¥æ ¼ç±»å‹
const where: QuestionFilter = {
  is_published: true,
};

const mode: QuestionMode = searchParams.get("mode") as QuestionMode || "chapter";
```

### é—®é¢˜ 3ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„

#### å½“å‰ä»£ç 
```typescript
// âŒ åªæœ‰console.error
} catch (error) {
  console.error("è·å–å¹´ä»½æ•°æ®å¤±è´¥:", error);
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šç»Ÿä¸€é”™è¯¯å¤„ç†

```typescript
// utils/error-handler.ts
export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500,
    public details?: any
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export const ERROR_CODES = {
  NETWORK_ERROR: { code: 'NETWORK_ERROR', message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' },
  API_ERROR: { code: 'API_ERROR', message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
  DATA_NOT_FOUND: { code: 'DATA_NOT_FOUND', message: 'æœªæ‰¾åˆ°ç›¸å…³æ•°æ®' },
  UNAUTHORIZED: { code: 'UNAUTHORIZED', message: 'è¯·å…ˆç™»å½•' },
} as const;

// ä½¿ç”¨
try {
  const response = await fetch(`/api/history-stats?exam=${examType}`);
  if (!response.ok) {
    throw new AppError(
      ERROR_CODES.API_ERROR.message,
      ERROR_CODES.API_ERROR.code,
      response.status
    );
  }
} catch (error) {
  if (error instanceof AppError) {
    toast.error(error.message);
    // å‘é€åˆ°é”™è¯¯ç›‘æ§
    Sentry.captureException(error, {
      tags: { code: error.code },
      extra: { details: error.details }
    });
  } else if (error instanceof TypeError) {
    toast.error(ERROR_CODES.NETWORK_ERROR.message);
  } else {
    toast.error('å‘ç”ŸæœªçŸ¥é”™è¯¯');
  }
  
  setError(error);
}
```

### é—®é¢˜ 4ï¼šé­”æ³•æ•°å­—

#### å½“å‰ä»£ç 
```typescript
// âŒ ä¸æ˜å«ä¹‰çš„æ•°å­—
const limit = parseInt(searchParams.get("limit") || "20");
if (year.correctRate > 0) { ... }
const progress = (year.completedQuestions / year.totalQuestions) * 100;
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šå¸¸é‡å®šä¹‰

```typescript
// constants/app.constants.ts
export const PAGINATION = {
  DEFAULT_LIMIT: 20,
  MAX_LIMIT: 100,
  DEFAULT_OFFSET: 0,
} as const;

export const THRESHOLDS = {
  MIN_CORRECT_RATE: 60, // æœ€ä½æ­£ç¡®ç‡è¦æ±‚
  EXCELLENT_RATE: 90,   // ä¼˜ç§€æ­£ç¡®ç‡
  PASS_RATE: 72,        // åŠæ ¼ç‡
} as const;

export const PERCENTAGE = {
  FULL: 100,
  HALF: 50,
} as const;

// ä½¿ç”¨
const limit = parseInt(searchParams.get("limit") || String(PAGINATION.DEFAULT_LIMIT));

if (year.correctRate >= THRESHOLDS.MIN_CORRECT_RATE) {
  // æ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
}

const progress = (year.completedQuestions / year.totalQuestions) * PERCENTAGE.FULL;
```

## ğŸŸ¡ ä»£ç ç»„ç»‡é—®é¢˜

### é—®é¢˜ 5ï¼šç»„ä»¶è¿‡å¤§

#### å½“å‰çŠ¶æ€
- `page.tsx`ï¼š352è¡Œ
- åŒ…å«å¤šä¸ªèŒè´£ï¼šæ•°æ®è·å–ã€UIæ¸²æŸ“ã€çŠ¶æ€ç®¡ç†

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šæ‹†åˆ†ç»„ä»¶

```typescript
// components/history/
â”œâ”€â”€ HistoryHeader.tsx          # é¡µé¢æ ‡é¢˜
â”œâ”€â”€ HistoryStats.tsx           # ç»Ÿè®¡å¡ç‰‡
â”œâ”€â”€ YearList.tsx               # å¹´ä»½åˆ—è¡¨
â”œâ”€â”€ YearCard.tsx               # å•ä¸ªå¹´ä»½å¡ç‰‡
â”‚   â”œâ”€â”€ YearCardHeader.tsx
â”‚   â”œâ”€â”€ YearCardProgress.tsx
â”‚   â”œâ”€â”€ YearCardSubjects.tsx
â”‚   â””â”€â”€ YearCardActions.tsx
â”œâ”€â”€ HistoryTips.tsx            # æç¤ºä¿¡æ¯
â””â”€â”€ index.ts                   # å¯¼å‡º

// hooks/
â”œâ”€â”€ useHistoryData.ts          # æ•°æ®è·å–é€»è¾‘
â”œâ”€â”€ useYearStatus.ts           # çŠ¶æ€è®¡ç®—é€»è¾‘
â””â”€â”€ useExamConfig.ts           # é…ç½®è·å–

// ä¸»é¡µé¢ç®€åŒ–ä¸º
export default function HistoryExamPage() {
  return (
    <ErrorBoundary>
      <Suspense fallback={<HistoryPageSkeleton />}>
        <HistoryExamContent />
      </Suspense>
    </ErrorBoundary>
  );
}

function HistoryExamContent() {
  const { yearData, loading, error } = useHistoryData();
  
  return (
    <div className="min-h-screen bg-gray-50">
      <HistoryHeader />
      <div className="container mx-auto px-4 py-8">
        <HistoryStats data={yearData} />
        <YearList data={yearData} loading={loading} error={error} />
        <HistoryTips />
      </div>
    </div>
  );
}
```

### é—®é¢˜ 6ï¼šè‡ªå®šä¹‰Hookç¼ºå¤±

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šæå–ä¸šåŠ¡é€»è¾‘

```typescript
// hooks/useHistoryData.ts
export function useHistoryData() {
  const searchParams = useSearchParams();
  const examType = searchParams.get("exam") || "pharmacist";
  const [yearData, setYearData] = useState<YearData[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    fetchData();
  }, [examType]);

  const fetchData = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/history-stats?exam=${examType}`);
      if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');
      const data = await response.json();
      setYearData(data.data);
    } catch (err) {
      setError(err as Error);
    } finally {
      setLoading(false);
    }
  };

  return { yearData, loading, error, refetch: fetchData };
}

// hooks/useYearStatus.ts
export function useYearStatus(year: YearData) {
  return useMemo(() => {
    if (year.totalQuestions === 0) {
      return { text: "æ•¬è¯·æœŸå¾…", color: "text-gray-400", bgColor: "bg-gray-50" };
    }
    if (year.completedQuestions === 0) {
      return { text: "æœªå¼€å§‹", color: "text-blue-500", bgColor: "bg-blue-50" };
    }
    if (year.completedQuestions === year.totalQuestions) {
      return { text: "å·²å®Œæˆ", color: "text-green-500", bgColor: "bg-green-50" };
    }
    return { text: "è¿›è¡Œä¸­", color: "text-orange-500", bgColor: "bg-orange-50" };
  }, [year.completedQuestions, year.totalQuestions]);
}
```

## ğŸŸ¢ æµ‹è¯•ä¸æ–‡æ¡£

### é—®é¢˜ 7ï¼šæ— å•å…ƒæµ‹è¯•

#### è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ æµ‹è¯•

```typescript
// __tests__/hooks/useHistoryData.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { useHistoryData } from '@/hooks/useHistoryData';

describe('useHistoryData', () => {
  it('should fetch year data successfully', async () => {
    const { result } = renderHook(() => useHistoryData());
    
    expect(result.current.loading).toBe(true);
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.yearData.length).toBeGreaterThan(0);
    expect(result.current.error).toBeNull();
  });
  
  it('should handle fetch error', async () => {
    global.fetch = jest.fn(() => Promise.reject(new Error('Network error')));
    
    const { result } = renderHook(() => useHistoryData());
    
    await waitFor(() => {
      expect(result.current.error).not.toBeNull();
    });
  });
});

// __tests__/components/YearCard.test.tsx
import { render, screen } from '@testing-library/react';
import { YearCard } from '@/components/history/YearCard';

describe('YearCard', () => {
  const mockYear = {
    year: 2024,
    totalQuestions: 120,
    completedQuestions: 60,
    correctRate: 75,
    subjects: [
      { name: 'ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½', count: 120 }
    ]
  };
  
  it('should render year card correctly', () => {
    render(<YearCard year={mockYear} />);
    
    expect(screen.getByText('2024å¹´çœŸé¢˜')).toBeInTheDocument();
    expect(screen.getByText('120 é“é¢˜')).toBeInTheDocument();
    expect(screen.getByText('50%')).toBeInTheDocument(); // è¿›åº¦
  });
});
```

### é—®é¢˜ 8ï¼šç¼ºå°‘æ–‡æ¡£

#### è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ æ³¨é‡Šå’ŒREADME

```typescript
/**
 * å†å¹´çœŸé¢˜åˆ—è¡¨é¡µé¢
 * 
 * @description
 * å±•ç¤ºå„å¹´ä»½çš„çœŸé¢˜ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¢˜ç›®æ•°é‡ã€å®Œæˆè¿›åº¦ã€æ­£ç¡®ç‡ç­‰ã€‚
 * æ”¯æŒæŒ‰ç§‘ç›®ç­›é€‰å’ŒæŸ¥çœ‹è¯¦ç»†é¢˜ç›®ã€‚
 * 
 * @features
 * - å¹´ä»½åˆ—è¡¨å±•ç¤º
 * - å®Œæˆè¿›åº¦ç»Ÿè®¡
 * - ç§‘ç›®åˆ†ç±»å¯¼èˆª
 * - æ¨¡æ‹Ÿè€ƒè¯•å…¥å£
 * 
 * @example
 * // è®¿é—®æ‰§ä¸šè¯å¸ˆå†å¹´çœŸé¢˜
 * /practice/history?exam=pharmacist
 * 
 * // è®¿é—®ä¸­åŒ»å¸ˆå†å¹´çœŸé¢˜
 * /practice/history?exam=tcm
 * 
 * @see {@link https://yikaobiguo.com/docs/history-exam}
 */
export default function HistoryExamPage() {
  // ...
}

/**
 * è®¡ç®—å¹´ä»½çŠ¶æ€
 * 
 * @param year - å¹´ä»½æ•°æ®å¯¹è±¡
 * @returns çŠ¶æ€å¯¹è±¡ï¼ŒåŒ…å«æ–‡æœ¬ã€é¢œè‰²å’ŒèƒŒæ™¯è‰²
 * 
 * @example
 * const status = getYearStatus({
 *   totalQuestions: 120,
 *   completedQuestions: 60
 * });
 * // => { text: "è¿›è¡Œä¸­", color: "text-orange-500", bgColor: "bg-orange-50" }
 */
function getYearStatus(year: YearData): YearStatus {
  // ...
}
```

## ğŸ”§ å¼€å‘å·¥å…·é…ç½®

### ESLinté…ç½®

```json
// .eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "no-console": ["warn", { "allow": ["warn", "error"] }],
    "prefer-const": "error",
    "no-var": "error",
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "react-hooks/exhaustive-deps": "error"
  }
}
```

### Prettieré…ç½®

```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": false,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false
}
```

### Husky + lint-staged

```json
// package.json
{
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ]
  },
  "scripts": {
    "prepare": "husky install"
  }
}
```

## ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å˜é‡éƒ½æœ‰æ˜ç¡®ç±»å‹
- [ ] æ— é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç 
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] ç»„ä»¶æ‹†åˆ†åˆç†ï¼ˆ<200è¡Œï¼‰
- [ ] ä¸šåŠ¡é€»è¾‘æå–åˆ°Hook
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ JSDocæ³¨é‡Š
- [ ] é€šè¿‡ESLintæ£€æŸ¥
- [ ] é€šè¿‡TypeScriptä¸¥æ ¼æ¨¡å¼
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆmemo/useMemoï¼‰
