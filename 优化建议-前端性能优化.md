# å‰ç«¯æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ”´ ä¸¥é‡æ€§èƒ½é—®é¢˜

### é—®é¢˜ 1ï¼šN+1 è¯·æ±‚ï¼ˆ16æ¬¡APIè°ƒç”¨ï¼‰

#### æ€§èƒ½å½±å“
- ç€‘å¸ƒæµè¯·æ±‚ï¼šæ€»è€—æ—¶ = æœ€æ…¢è¯·æ±‚æ—¶é—´
- ç§»åŠ¨ç½‘ç»œä¸‹å¯èƒ½è¶…è¿‡5ç§’

#### è§£å†³æ–¹æ¡ˆï¼šè¯·æ±‚åˆå¹¶

```typescript
// ä¼˜åŒ–å‰ï¼š16æ¬¡è¯·æ±‚
const subjectPromises = subjects.map(async (subject) => {
  const response = await fetch(`/api/questions?...`); // 4å¹´Ã—4ç§‘ç›®=16æ¬¡
});

// ä¼˜åŒ–åï¼š1æ¬¡è¯·æ±‚
const response = await fetch(`/api/history-stats?exam=${examType}`);
const yearData = await response.json();

// æ€§èƒ½æå‡ï¼š5000ms â†’ 200msï¼ˆæå‡25å€ï¼‰
```

### é—®é¢˜ 2ï¼šæ— è¯·æ±‚ç¼“å­˜

#### å½“å‰çŠ¶æ€
- æ¯æ¬¡è®¿é—®éƒ½é‡æ–°è¯·æ±‚
- æµªè´¹å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æº

#### è§£å†³æ–¹æ¡ˆï¼šå¤šçº§ç¼“å­˜

```typescript
// 1. HTTPç¼“å­˜ï¼ˆæœåŠ¡ç«¯ï¼‰
export const revalidate = 3600; // Next.js ISRï¼Œ1å°æ—¶ç¼“å­˜

// 2. SWRå®¢æˆ·ç«¯ç¼“å­˜
import useSWR from 'swr';

const { data, error, isLoading } = useSWR(
  `/api/history-stats?exam=${examType}`,
  fetcher,
  {
    revalidateOnFocus: false, // åˆ‡å›é¡µé¢æ—¶ä¸é‡æ–°è¯·æ±‚
    revalidateOnReconnect: false, // é‡è¿æ—¶ä¸é‡æ–°è¯·æ±‚
    dedupingInterval: 60000, // 60ç§’å†…å»é‡
  }
);

// 3. LocalStorageæŒä¹…åŒ–ï¼ˆç¦»çº¿æ”¯æŒï¼‰
const cachedData = localStorage.getItem('history-stats');
if (cachedData) {
  const { data, timestamp } = JSON.parse(cachedData);
  if (Date.now() - timestamp < 3600000) { // 1å°æ—¶å†…
    setYearData(data); // ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®
  }
}

// è¯·æ±‚æˆåŠŸåæ›´æ–°ç¼“å­˜
localStorage.setItem('history-stats', JSON.stringify({
  data: yearData,
  timestamp: Date.now()
}));
```

### é—®é¢˜ 3ï¼šç»„ä»¶é‡æ¸²æŸ“è¿‡å¤š

#### è¯Šæ–­å·¥å…·

```typescript
// ä½¿ç”¨ React DevTools Profiler
// æˆ–æ·»åŠ æ€§èƒ½ç›‘æ§

import { useEffect, useRef } from 'react';

function useRenderCount(componentName: string) {
  const renderCount = useRef(0);
  
  useEffect(() => {
    renderCount.current += 1;
    console.log(`${componentName} æ¸²æŸ“æ¬¡æ•°:`, renderCount.current);
  });
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function HistoryExamContent() {
  useRenderCount('HistoryExamContent');
  // ...
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šReact.memo + useMemo

```typescript
// å¹´ä»½å¡ç‰‡ç»„ä»¶æŠ½ç¦»
const YearCard = React.memo(({ year }: { year: YearData }) => {
  const status = useMemo(() => getYearStatus(year), [year]);
  const progress = useMemo(
    () => year.totalQuestions > 0 
      ? (year.completedQuestions / year.totalQuestions) * 100 
      : 0,
    [year.completedQuestions, year.totalQuestions]
  );

  return (
    <div className="year-card">
      {/* ... */}
    </div>
  );
});

// ä¸»ç»„ä»¶
function HistoryExamContent() {
  return yearData.map(year => (
    <YearCard key={year.year} year={year} />
  ));
}
```

### é—®é¢˜ 4ï¼šå›¾ç‰‡æœªä¼˜åŒ–

#### å½“å‰é—®é¢˜
- æ— æ‡’åŠ è½½
- æ— ç°ä»£æ ¼å¼ï¼ˆWebPï¼‰
- æ— å“åº”å¼å›¾ç‰‡

#### è§£å†³æ–¹æ¡ˆï¼šNext.js Imageç»„ä»¶

```typescript
import Image from 'next/image';

// æ›¿æ¢æ‰€æœ‰ <img> æ ‡ç­¾
<Image
  src={user.avatar}
  alt={user.name}
  width={40}
  height={40}
  className="rounded-full"
  loading="lazy" // æ‡’åŠ è½½
  quality={75} // å‹ç¼©è´¨é‡
/>

// è‡ªåŠ¨ç”ŸæˆWebP + å“åº”å¼srcset
```

## ğŸŸ¡ ä¸­ç­‰ä¼˜å…ˆçº§ä¼˜åŒ–

### é—®é¢˜ 5ï¼šCSSä½“ç§¯å¤§

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šPurgeCSSï¼ˆTailwindå·²å†…ç½®ï¼‰

```javascript
// tailwind.config.ts ç¡®ä¿é…ç½®æ­£ç¡®
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx}', // æ‰«ææ‰€æœ‰æ–‡ä»¶
    './components/**/*.{js,ts,jsx,tsx}',
  ],
  // ...
}

// ç”Ÿäº§æ„å»ºæ—¶è‡ªåŠ¨ç§»é™¤æœªä½¿ç”¨çš„CSS
// ä½“ç§¯å‡å°‘ï¼š200KB â†’ 20KB
```

### é—®é¢˜ 6ï¼šJavaScriptåŒ…ä½“ç§¯

#### åˆ†æå·¥å…·

```bash
# å®‰è£…åˆ†æå·¥å…·
npm install @next/bundle-analyzer

# next.config.js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

module.exports = withBundleAnalyzer({
  // ...
});

# è¿è¡Œåˆ†æ
ANALYZE=true npm run build
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šåŠ¨æ€å¯¼å…¥

```typescript
// å°†å¤§å‹ç»„ä»¶å»¶è¿ŸåŠ è½½
const ChartComponent = dynamic(() => import('./ChartComponent'), {
  loading: () => <div>åŠ è½½å›¾è¡¨ä¸­...</div>,
  ssr: false // ä¸åœ¨æœåŠ¡ç«¯æ¸²æŸ“
});

// åªåœ¨éœ€è¦æ—¶åŠ è½½
{showChart && <ChartComponent data={chartData} />}
```

### é—®é¢˜ 7ï¼šæ— ä»£ç åˆ†å‰²

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šè·¯ç”±çº§åˆ†å‰²

```typescript
// Next.jsè‡ªåŠ¨æŒ‰è·¯ç”±åˆ†å‰²
// ä½†å¯ä»¥æ‰‹åŠ¨ä¼˜åŒ–å¤§ç»„ä»¶

// ç§‘ç›®åˆ—è¡¨å»¶è¿Ÿæ¸²æŸ“ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰
import { FixedSizeList as List } from 'react-window';

<List
  height={600}
  itemCount={subjects.length}
  itemSize={60}
  width="100%"
>
  {({ index, style }) => (
    <div style={style}>
      <SubjectItem subject={subjects[index]} />
    </div>
  )}
</List>

// åªæ¸²æŸ“å¯è§åŒºåŸŸï¼Œæ€§èƒ½æå‡10å€
```

## ğŸŸ¢ æ€§èƒ½ç›‘æ§

### Web Vitalsç›‘æ§

```typescript
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react';
import { SpeedInsights } from '@vercel/speed-insights/next';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  );
}

// è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§
export function reportWebVitals(metric: NextWebVitalsMetric) {
  console.log(metric);
  
  // å‘é€åˆ°åˆ†ææœåŠ¡
  if (metric.label === 'web-vital') {
    gtag('event', metric.name, {
      value: Math.round(metric.value),
      event_label: metric.id,
      non_interaction: true,
    });
  }
}
```

### æ€§èƒ½é¢„ç®—

```json
// .lighthouserc.json
{
  "ci": {
    "assert": {
      "assertions": {
        "first-contentful-paint": ["error", { "maxNumericValue": 2000 }],
        "largest-contentful-paint": ["error", { "maxNumericValue": 2500 }],
        "cumulative-layout-shift": ["error", { "maxNumericValue": 0.1 }],
        "total-blocking-time": ["error", { "maxNumericValue": 300 }]
      }
    }
  }
}
```

## ğŸš€ æè‡´ä¼˜åŒ–æŠ€å·§

### 1. é¢„è¿æ¥å…³é”®åŸŸå

```typescript
// app/layout.tsx
export default function RootLayout() {
  return (
    <html>
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="https://api.yikaobiguo.com" />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

### 2. é¢„åŠ è½½å…³é”®èµ„æº

```typescript
// é¢„åŠ è½½ä¸‹ä¸€å¹´çš„æ•°æ®
<Link
  href={`/practice/history/2023`}
  onMouseEnter={() => {
    // é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½
    router.prefetch(`/practice/history/2023`);
  }}
>
  2023å¹´çœŸé¢˜
</Link>
```

### 3. å­—ä½“ä¼˜åŒ–

```typescript
// app/layout.tsx
import { Inter } from 'next/font/google';

const inter = Inter({ 
  subsets: ['latin'],
  display: 'swap', // å­—ä½“åŠ è½½æœŸé—´æ˜¾ç¤ºç³»ç»Ÿå­—ä½“
  preload: true,
  variable: '--font-inter'
});

// ä½¿ç”¨å¯å˜å­—ä½“å‡å°‘æ–‡ä»¶å¤§å°
```

### 4. æœåŠ¡ç«¯ç»„ä»¶ä¼˜åŒ–

```typescript
// å°†é™æ€éƒ¨åˆ†æ”¹ä¸ºæœåŠ¡ç«¯ç»„ä»¶ï¼ˆRSCï¼‰
// app/practice/history/layout.tsx
export default function Layout({ children }) {
  return (
    <>
      {/* æœåŠ¡ç«¯æ¸²æŸ“çš„å¯¼èˆªæ  */}
      <StaticNavbar />
      {/* å®¢æˆ·ç«¯äº¤äº’ç»„ä»¶ */}
      {children}
    </>
  );
}

// å‡å°‘å®¢æˆ·ç«¯JavaScriptä½“ç§¯
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”é¢„æµ‹

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| LCP | 4.2s | 1.8s | âš¡ 133% |
| FCP | 2.1s | 0.9s | âš¡ 133% |
| TTI | 5.5s | 2.3s | âš¡ 139% |
| Bundle Size | 350KB | 120KB | âš¡ 192% |
| API Requests | 16æ¬¡ | 1æ¬¡ | âš¡ 1500% |

## ğŸ”§ å®æ–½ä¼˜å…ˆçº§

1. âš ï¸ **P0ï¼ˆç«‹å³ï¼‰**ï¼šåˆå¹¶APIè¯·æ±‚ã€æ·»åŠ ç¼“å­˜
2. ğŸ”¥ **P1ï¼ˆæœ¬å‘¨ï¼‰**ï¼šReact.memoä¼˜åŒ–ã€éª¨æ¶å±
3. ğŸ“ˆ **P2ï¼ˆæœ¬æœˆï¼‰**ï¼šå›¾ç‰‡ä¼˜åŒ–ã€ä»£ç åˆ†å‰²
4. âœ¨ **P3ï¼ˆè¿­ä»£ï¼‰**ï¼šè™šæ‹Ÿæ»šåŠ¨ã€ç¦»çº¿æ”¯æŒ
