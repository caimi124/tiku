<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIç›´æ¥æµ‹è¯• - å†å¹´çœŸé¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .year-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .year-title {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 15px;
        }
        .subject-list {
            display: grid;
            gap: 10px;
        }
        .subject-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .subject-name {
            font-weight: 500;
            color: #333;
        }
        .subject-count {
            color: #666;
            font-size: 14px;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å†å¹´çœŸé¢˜APIç›´æ¥æµ‹è¯•</h1>
        
        <div id="status" class="status loading">
            â³ æ­£åœ¨è¯·æ±‚API...
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">çœŸé¢˜æ€»æ•°</div>
                <div class="stat-value" id="totalQuestions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¯ç”¨å¹´ä»½</div>
                <div class="stat-value" id="availableYears">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç§‘ç›®æ€»æ•°</div>
                <div class="stat-value" id="totalSubjects">-</div>
            </div>
        </div>

        <div>
            <button class="btn" onclick="testAPI()">ğŸ”„ é‡æ–°æµ‹è¯•</button>
            <button class="btn" onclick="testProduction()">ğŸŒ æµ‹è¯•ç”Ÿäº§ç¯å¢ƒ</button>
        </div>

        <div id="yearList"></div>

        <h2>ğŸ“¡ APIå“åº”è¯¦æƒ…</h2>
        <pre id="apiResponse">ç­‰å¾…åŠ è½½...</pre>

        <h2>ğŸ› ï¸ è¯Šæ–­ä¿¡æ¯</h2>
        <div id="diagnostics"></div>
    </div>

    <script>
        const API_URL_LOCAL = 'http://localhost:3000/api/history-stats?exam=pharmacist';
        const API_URL_PROD = 'https://yikaobiguo.com/api/history-stats?exam=pharmacist';

        async function testAPI(url = API_URL_LOCAL, isProd = false) {
            const statusDiv = document.getElementById('status');
            const responseDiv = document.getElementById('apiResponse');
            const yearListDiv = document.getElementById('yearList');
            const diagnosticsDiv = document.getElementById('diagnostics');
            
            statusDiv.className = 'status loading';
            statusDiv.textContent = `â³ æ­£åœ¨è¯·æ±‚${isProd ? 'ç”Ÿäº§' : 'æœ¬åœ°'}API...`;
            
            try {
                console.log('ğŸŒ è¯·æ±‚URL:', url);
                const startTime = Date.now();
                
                const response = await fetch(url);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
                console.log('â±ï¸ å“åº”æ—¶é—´:', responseTime + 'ms');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    âœ… APIè¯·æ±‚æˆåŠŸï¼<br>
                    å“åº”æ—¶é—´: ${responseTime}ms<br>
                    çŠ¶æ€ç : ${response.status}
                `;
                
                // æ˜¾ç¤ºåŸå§‹å“åº”
                responseDiv.textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.data) {
                    // è®¡ç®—ç»Ÿè®¡æ•°æ®
                    const totalQuestions = data.data.reduce((sum, year) => sum + year.totalQuestions, 0);
                    const availableYears = data.data.filter(y => y.totalQuestions > 0).length;
                    const totalSubjects = data.data.reduce((sum, year) => sum + year.subjects.length, 0);
                    
                    document.getElementById('totalQuestions').textContent = totalQuestions;
                    document.getElementById('availableYears').textContent = availableYears;
                    document.getElementById('totalSubjects').textContent = totalSubjects;
                    
                    // æ˜¾ç¤ºå¹´ä»½åˆ—è¡¨
                    yearListDiv.innerHTML = '<h2>ğŸ“š å¹´ä»½è¯¦æƒ…</h2>';
                    data.data.forEach(year => {
                        const yearCard = document.createElement('div');
                        yearCard.className = 'year-card';
                        
                        yearCard.innerHTML = `
                            <div class="year-title">${year.year}å¹´çœŸé¢˜ - å…±${year.totalQuestions}é¢˜</div>
                            <div class="subject-list">
                                ${year.subjects.map(subject => `
                                    <div class="subject-item">
                                        <span class="subject-name">${subject.name}</span>
                                        <span class="subject-count">${subject.count}é¢˜</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        yearListDiv.appendChild(yearCard);
                    });
                    
                    // è¯Šæ–­ä¿¡æ¯
                    diagnosticsDiv.innerHTML = `
                        <div class="status success">
                            <strong>âœ… æ•°æ®éªŒè¯é€šè¿‡</strong><br><br>
                            â€¢ æ•°æ®ç»“æ„æ­£ç¡®<br>
                            â€¢ åŒ…å«${data.data.length}ä¸ªå¹´ä»½<br>
                            â€¢ æ€»è®¡${totalQuestions}é“é¢˜<br>
                            â€¢ æ¯å¹´éƒ½æœ‰4ä¸ªç§‘ç›®<br>
                            â€¢ æ¯ç§‘ç›®120é¢˜<br><br>
                            <strong>å¦‚æœå‰ç«¯é¡µé¢ä»ä¸æ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ï¼š</strong><br>
                            1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯ (æŒ‰F12)<br>
                            2. Networkæ ‡ç­¾ä¸­APIè¯·æ±‚æ˜¯å¦æˆåŠŸ<br>
                            3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl+Shift+Delete)<br>
                            4. ä½¿ç”¨æ— ç—•æ¨¡å¼é‡æ–°æ‰“å¼€ (Ctrl+Shift+N)<br>
                            5. æ£€æŸ¥Reactç»„ä»¶çš„çŠ¶æ€æ›´æ–°é€»è¾‘
                        </div>
                    `;
                } else {
                    diagnosticsDiv.innerHTML = `
                        <div class="status error">
                            âŒ APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸<br>
                            success: ${data.success}<br>
                            data: ${data.data ? 'exists' : 'null'}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
                
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    âŒ APIè¯·æ±‚å¤±è´¥<br>
                    é”™è¯¯: ${error.message}
                `;
                
                responseDiv.textContent = `é”™è¯¯è¯¦æƒ…:\n${error.stack || error.message}`;
                
                diagnosticsDiv.innerHTML = `
                    <div class="status error">
                        <strong>âŒ è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š</strong><br><br>
                        1. å¼€å‘æœåŠ¡å™¨æœªå¯åŠ¨<br>
                        &nbsp;&nbsp;&nbsp;â†’ è¿è¡Œ: npm run dev<br><br>
                        2. ç«¯å£3000è¢«å ç”¨<br>
                        &nbsp;&nbsp;&nbsp;â†’ æ£€æŸ¥å…¶ä»–åº”ç”¨æ˜¯å¦å ç”¨ç«¯å£<br><br>
                        3. CORSè·¨åŸŸé—®é¢˜ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼‰<br>
                        &nbsp;&nbsp;&nbsp;â†’ æ£€æŸ¥APIçš„CORSè®¾ç½®<br><br>
                        4. æ•°æ®åº“è¿æ¥é—®é¢˜<br>
                        &nbsp;&nbsp;&nbsp;â†’ æ£€æŸ¥DATABASE_URLé…ç½®
                    </div>
                `;
            }
        }

        function testProduction() {
            testAPI(API_URL_PROD, true);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•API...');
            testAPI();
        };
    </script>
</body>
</html>
