# ğŸ—„ï¸ æ•°æ®åº“é…ç½®æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

éƒ¨ç½²åˆ° Vercel éœ€è¦é…ç½®ç”Ÿäº§æ•°æ®åº“ã€‚ä»¥ä¸‹æ˜¯ä¸‰ç§æ¨èæ–¹æ¡ˆï¼š

---

## ğŸ¯ æ–¹æ¡ˆä¸€ï¼šVercel Postgresï¼ˆæœ€ç®€å•ï¼Œæ¨èï¼‰

### ä¼˜ç‚¹
- âœ… ä¸ Vercel å®Œç¾é›†æˆ
- âœ… è‡ªåŠ¨è®¾ç½®ç¯å¢ƒå˜é‡
- âœ… å…è´¹é¢åº¦ï¼š256MB å­˜å‚¨ï¼Œ60 å°æ—¶è®¡ç®—æ—¶é—´/æœˆ
- âœ… æ— éœ€é¢å¤–é…ç½®

### é…ç½®æ­¥éª¤

1. **è¿›å…¥ Vercel Dashboard**
   - è®¿é—®ï¼šhttps://vercel.com/dashboard
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®

2. **åˆ›å»ºæ•°æ®åº“**
   - ç‚¹å‡»é¡¶éƒ¨ **Storage** æ ‡ç­¾
   - ç‚¹å‡» **Create Database**
   - é€‰æ‹© **Postgres**
   - é€‰æ‹©åŒºåŸŸï¼ˆå»ºè®®é€‰æ‹©ä¸éƒ¨ç½²ç›¸åŒçš„åŒºåŸŸï¼‰
   - ç‚¹å‡» **Create**

3. **è¿æ¥åˆ°é¡¹ç›®**
   - Vercel ä¼šè‡ªåŠ¨è¯¢é—®æ˜¯å¦è¿æ¥åˆ°é¡¹ç›®
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®
   - ç‚¹å‡» **Connect**
   - âœ… å®Œæˆï¼ç¯å¢ƒå˜é‡è‡ªåŠ¨è®¾ç½®

4. **åˆå§‹åŒ–æ•°æ®åº“**
   ```bash
   # è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆåœ¨ Vercel Storage > Postgres > .env.localï¼‰
   # å¤åˆ¶ DATABASE_URL
   
   # åœ¨æœ¬åœ°è¿è¡Œ
   DATABASE_URL="å¤åˆ¶çš„URL" npx prisma db push
   ```

---

## ğŸŒŸ æ–¹æ¡ˆäºŒï¼šSupabaseï¼ˆå…è´¹ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼‰

### ä¼˜ç‚¹
- âœ… å®Œå…¨å…è´¹ï¼ˆ500MB æ•°æ®åº“ + 1GB æ–‡ä»¶å­˜å‚¨ï¼‰
- âœ… æä¾› REST API å’Œå®æ—¶åŠŸèƒ½
- âœ… è‡ªå¸¦åå°ç®¡ç†ç•Œé¢
- âœ… æ°¸ä¹…å…è´¹è®¡åˆ’

### é…ç½®æ­¥éª¤

1. **æ³¨å†Œ Supabase**
   - è®¿é—®ï¼šhttps://supabase.com
   - ä½¿ç”¨ GitHub è´¦å·ç™»å½•

2. **åˆ›å»ºé¡¹ç›®**
   - ç‚¹å‡» **New Project**
   - è¾“å…¥é¡¹ç›®åç§°ï¼š`medexam-pro`
   - è®¾ç½®æ•°æ®åº“å¯†ç ï¼ˆè¯·è®°ä½ï¼ï¼‰
   - é€‰æ‹©åŒºåŸŸï¼š**Southeast Asia (Singapore)** æˆ–æœ€è¿‘çš„åŒºåŸŸ
   - ç‚¹å‡» **Create new project**

3. **è·å–è¿æ¥å­—ç¬¦ä¸²**
   - ç­‰å¾…é¡¹ç›®åˆ›å»ºï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
   - ç‚¹å‡»å·¦ä¾§ **Settings** âš™ï¸
   - ç‚¹å‡» **Database**
   - æ‰¾åˆ° **Connection string** éƒ¨åˆ†
   - é€‰æ‹© **URI** æ ¼å¼
   - å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚ï¼š
     ```
     postgresql://postgres:[YOUR-PASSWORD]@db.xxx.supabase.co:5432/postgres
     ```
   - å°† `[YOUR-PASSWORD]` æ›¿æ¢ä¸ºæ‚¨çš„æ•°æ®åº“å¯†ç 

4. **åœ¨ Vercel è®¾ç½®ç¯å¢ƒå˜é‡**
   - è¿›å…¥ Vercel é¡¹ç›®
   - Settings > Environment Variables
   - æ·»åŠ ï¼š
     ```
     Name: DATABASE_URL
     Value: postgresql://postgres:ä½ çš„å¯†ç @db.xxx.supabase.co:5432/postgres
     ```
   - é€‰æ‹©æ‰€æœ‰ç¯å¢ƒï¼ˆProduction, Preview, Developmentï¼‰
   - ç‚¹å‡» **Save**

5. **é‡æ–°éƒ¨ç½²**
   - è¿›å…¥ Deployments æ ‡ç­¾
   - ç‚¹å‡»æœ€æ–°éƒ¨ç½²çš„ä¸‰ä¸ªç‚¹ â‹¯
   - ç‚¹å‡» **Redeploy**

---

## âš¡ æ–¹æ¡ˆä¸‰ï¼šNeonï¼ˆæ— æœåŠ¡å™¨ Postgresï¼‰

### ä¼˜ç‚¹
- âœ… å…è´¹è®¡åˆ’ï¼š3 GB å­˜å‚¨
- âœ… æ— æœåŠ¡å™¨æ¶æ„ï¼ŒæŒ‰éœ€æ‰©å±•
- âœ… æ”¯æŒåˆ†æ”¯ï¼ˆç±»ä¼¼ Gitï¼‰
- âœ… å“åº”é€Ÿåº¦å¿«

### é…ç½®æ­¥éª¤

1. **æ³¨å†Œ Neon**
   - è®¿é—®ï¼šhttps://neon.tech
   - ä½¿ç”¨ GitHub è´¦å·ç™»å½•

2. **åˆ›å»ºé¡¹ç›®**
   - ç‚¹å‡» **Create a project**
   - é¡¹ç›®åç§°ï¼š`medexam-pro`
   - é€‰æ‹©åŒºåŸŸï¼šé€‰æ‹©æœ€è¿‘çš„
   - Postgres ç‰ˆæœ¬ï¼š16ï¼ˆé»˜è®¤ï¼‰
   - ç‚¹å‡» **Create project**

3. **è·å–è¿æ¥å­—ç¬¦ä¸²**
   - é¡¹ç›®åˆ›å»ºåè‡ªåŠ¨æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
   - å¤åˆ¶ **Connection string**
   - æ ¼å¼ï¼š
     ```
     postgresql://user:password@ep-xxx.region.aws.neon.tech/dbname?sslmode=require
     ```

4. **é…ç½® Vercel**ï¼ˆåŒæ–¹æ¡ˆäºŒçš„ç¬¬4æ­¥ï¼‰

5. **ä¼˜åŒ–é…ç½®**
   åœ¨ `lib/prisma.ts` ä¸­æ·»åŠ è¿æ¥æ± é…ç½®ï¼š
   ```typescript
   import { PrismaClient } from '@prisma/client'
   
   const globalForPrisma = globalThis as unknown as {
     prisma: PrismaClient | undefined
   }
   
   export const prisma = globalForPrisma.prisma ?? new PrismaClient({
     datasources: {
       db: {
         url: process.env.DATABASE_URL,
       },
     },
     log: ['query', 'error', 'warn'],
   })
   
   if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
   ```

---

## ğŸ” æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | Vercel Postgres | Supabase | Neon |
|------|----------------|----------|------|
| **å…è´¹é¢åº¦** | 256MB | 500MB | 3GB |
| **è®¾ç½®éš¾åº¦** | â­ æœ€ç®€å• | â­â­ ç®€å• | â­â­ ç®€å• |
| **é›†æˆåº¦** | å®Œç¾é›†æˆ Vercel | éœ€æ‰‹åŠ¨é…ç½® | éœ€æ‰‹åŠ¨é…ç½® |
| **é¢å¤–åŠŸèƒ½** | åŸºç¡€ | å®æ—¶ã€å­˜å‚¨ã€è®¤è¯ | æ•°æ®åº“åˆ†æ”¯ |
| **æ€§èƒ½** | ä¼˜ç§€ | ä¼˜ç§€ | æä½³ |
| **æ¨èåº¦** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

---

## ğŸ“Š æ•°æ®åº“åˆå§‹åŒ–

é…ç½®å¥½æ•°æ®åº“åï¼Œéœ€è¦åˆå§‹åŒ–è¡¨ç»“æ„å’Œæ•°æ®ï¼š

### æ–¹æ³•1: æœ¬åœ°æ¨é€ï¼ˆæ¨èï¼‰

```bash
# 1. è®¾ç½®æ•°æ®åº“ URLï¼ˆä¸´æ—¶ï¼‰
set DATABASE_URL=ä½ çš„ç”Ÿäº§æ•°æ®åº“URL

# 2. æ¨é€æ•°æ®åº“ç»“æ„
npx prisma db push

# 3. æŸ¥çœ‹ schema ç¡®è®¤
npx prisma studio
```

### æ–¹æ³•2: åˆ›å»ºåˆå§‹åŒ– API

åˆ›å»º `app/api/init-db/route.ts`ï¼š

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

// æ·»åŠ ç®€å•çš„å¯†é’¥ä¿æŠ¤
const INIT_SECRET = process.env.INIT_SECRET || 'change-me-in-production';

export async function POST(request: Request) {
  try {
    // éªŒè¯å¯†é’¥
    const { secret } = await request.json();
    if (secret !== INIT_SECRET) {
      return NextResponse.json({ error: 'æœªæˆæƒ' }, { status: 401 });
    }

    // è¿™é‡Œæ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–é€»è¾‘
    // ä¾‹å¦‚åˆ›å»ºé»˜è®¤ç”¨æˆ·ã€é¢˜ç›®ç­‰
    
    return NextResponse.json({ 
      success: true,
      message: 'æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ' 
    });
  } catch (error) {
    console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
    return NextResponse.json({ 
      error: 'åˆå§‹åŒ–å¤±è´¥',
      details: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    }, { status: 500 });
  }
}
```

ç„¶åè®¿é—®ï¼š
```
POST https://ä½ çš„åŸŸå.vercel.app/api/init-db
Body: { "secret": "ä½ çš„å¯†é’¥" }
```

---

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡ç®¡ç†

**æœ¬åœ°å¼€å‘** - åˆ›å»º `.env.local`ï¼š
```bash
DATABASE_URL="postgresql://localhost:5432/medexam_dev"
```

**ç”Ÿäº§ç¯å¢ƒ** - åœ¨ Vercel è®¾ç½®ï¼š
```bash
DATABASE_URL="ä½ çš„ç”Ÿäº§æ•°æ®åº“URL"
```

### 2. è¿æ¥å­—ç¬¦ä¸²æ ¼å¼

æ ‡å‡†æ ¼å¼ï¼š
```
postgresql://ç”¨æˆ·å:å¯†ç @ä¸»æœº:ç«¯å£/æ•°æ®åº“å?å‚æ•°
```

ç¤ºä¾‹ï¼š
```
postgresql://postgres:mypassword@db.example.com:5432/medexam?schema=public&connection_limit=10
```

### 3. è¿æ¥æ± é…ç½®

å¯¹äº Serverless ç¯å¢ƒï¼Œå»ºè®®é™åˆ¶è¿æ¥æ•°ï¼š
```
?connection_limit=10&pool_timeout=10
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥è¶…æ—¶
**åŸå› **: æ•°æ®åº“æœåŠ¡å™¨å¯èƒ½åœ¨ç¡çœ çŠ¶æ€ï¼ˆå…è´¹è®¡åˆ’ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- Supabase/Neon å…è´¹è®¡åˆ’ä¼šåœ¨ä¸æ´»åŠ¨åä¼‘çœ 
- ç¬¬ä¸€æ¬¡è¯·æ±‚ä¼šå”¤é†’ï¼ˆéœ€è¦å‡ ç§’ï¼‰
- è€ƒè™‘æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¿æŒå”¤é†’

### Q2: è¿æ¥æ•°è¿‡å¤š
**ç—‡çŠ¶**: `Error: P1001: Too many connections`

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// lib/prisma.ts - å•ä¾‹æ¨¡å¼
const prisma = globalThis.prisma || new PrismaClient()
if (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma
```

### Q3: SSL è¿æ¥é—®é¢˜
**ç—‡çŠ¶**: `SSL connection error`

**è§£å†³æ–¹æ¡ˆ**:
åœ¨è¿æ¥å­—ç¬¦ä¸²æ·»åŠ ï¼š
```
?sslmode=require
```

---

## ğŸ¯ æ¨èé…ç½®æ­¥éª¤

1. âœ… **ç¬¬ä¸€æ¬¡éƒ¨ç½²**: ä½¿ç”¨ Vercel Postgresï¼ˆæœ€ç®€å•ï¼‰
2. âœ… **éœ€è¦æ›´å¤šåŠŸèƒ½**: åˆ‡æ¢åˆ° Supabase
3. âœ… **éœ€è¦æ›´å¤§å­˜å‚¨**: åˆ‡æ¢åˆ° Neon
4. âœ… **ç”Ÿäº§ç¯å¢ƒ**: è€ƒè™‘ä»˜è´¹è®¡åˆ’

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

### æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
```bash
# éªŒè¯è¿æ¥
DATABASE_URL="ä½ çš„URL" npx prisma db execute --stdin <<< "SELECT NOW();"

# æŸ¥çœ‹è¡¨ç»“æ„
DATABASE_URL="ä½ çš„URL" npx prisma db pull
```

### æ•°æ®åº“ç®¡ç†å·¥å…·
- **Prisma Studio**: `npx prisma studio`
- **Supabase Dashboard**: https://app.supabase.com
- **Neon Console**: https://console.neon.tech

---

**å®Œæˆæ•°æ®åº“é…ç½®åï¼Œæ‚¨çš„ç½‘ç«™å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼** ğŸ‰

