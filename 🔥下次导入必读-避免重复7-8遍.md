# 🔥 下次导入必读 - 避免重复7-8遍

**重要提醒**: 这次导入遇到了5大类问题，花费了大量时间反复修复。为避免下次重复，请严格按照本文档操作！

---

## ⚡ 快速检查清单（导入前必做）

```bash
# 1️⃣ 检查图示题是否有错误选项
node -e "const data = require('./shuju/xxx.json'); data.forEach(q => { if (q.question.includes('图示') && q.options.length > 0) { console.log('⚠️ 图示题' + q.number + '有选项:', q.options[0]); } });"

# 2️⃣ 检查题目内容是否串题
node -e "const data = require('./shuju/xxx.json'); data.forEach(q => { if (q.question.length > 150 && (q.question.includes('案例：') || q.question.includes('三、综合分析题'))) { console.log('⚠️ 题' + q.number + '内容过长(' + q.question.length + '字符)，可能串题'); } });"

# 3️⃣ 检查配伍题选项是否合理
node -e "const data = require('./shuju/xxx.json'); data.filter(q => q.number >= 41 && q.number <= 90).forEach(q => { if (q.options.length > 0 && (q.options[0].includes('散剂') || q.options[0].includes('乳膏剂') || q.options[0].includes('聚乙烯醇'))) { console.log('⚠️ 题' + q.number + '选项可能错误:', q.options[0]); } });"
```

**如果发现问题** → 必须先修复JSON数据，或使用修复版导入脚本！

---

## 🎯 5大问题及永久解决方案

### 问题1：选项内容错误
**现象**: 配伍题显示辅料名（聚乙烯醇）而非药材名（苦参）  
**原因**: JSON数据选项错位  
**永久方案**: 黑名单过滤

```typescript
const invalidKeywords = [
  '聚乙烯醇', '亚硫酸钠', '苯乙醇', '葡萄糖', '卵磷脂', // 辅料
  '散剂', '颗粒剂', '蜜丸', '舌下片', '口服液', // 剂型
  '乳膏剂', '凝胶剂', '喷雾剂', '贴膏剂', '栓剂'
];
```

**记住**: 永远不要相信JSON中的选项是正确的，必须验证！

---

### 问题2：选项错位叠加（最危险）
**现象**: 
- 图示题显示文字选项
- 配伍题没有选项
- 选项"前移"

**原因**: JSON数据编辑错误，选项放错了位置  
**永久方案**: 优先级判断 + 智能重定向

```typescript
// 优先级1: 图示题强制空选项（最高优先级）
if (q.question.includes('图示')) {
  return ['A.', 'B.', 'C.', 'D.', 'E.'];
}

// 优先级2: 特殊题号智能重定向
if (q.number === 41 || q.number === 42) {
  return all.find(x => x.number === 40).options; // 从题40获取
}
```

**记住**: 
1. 图示题永远不应该有文字选项
2. 如果发现图示题有选项，说明选项被前移了
3. 必须从前一题"窃取"选项给后续题

---

### 问题3：配伍题缺选项
**现象**: 只显示"A. B. C. D. E."  
**原因**: JSON中配伍题选项为空  
**永久方案**: 向前查找 + 黑名单验证

```typescript
// 配伍题向前查找10题内的有效选项
for (let i = currentIndex - 1; i >= currentIndex - 10; i--) {
  if (prevQ.options.length > 0 && !isInvalid) {
    return prevQ.options;
  }
}
```

**记住**: 配伍题题组共用选项，必须向前查找

---

### 问题4：题目内容串题
**现象**: 题目包含下一题的案例或章节标题  
**原因**: JSON编辑时题目分割不准确  
**永久方案**: 自动清洗

```typescript
const markers = [
  '二、配伍选择题',
  '三、综合分析题',
  '四、多项选择题',
  '案例：'
];

for (const marker of markers) {
  const index = content.indexOf(marker);
  if (index !== -1) {
    content = content.substring(0, index).trim();
  }
}
```

**记住**: 题目内容长度超过100字符要警惕！

---

### 问题5：案例内容缺失
**现象**: 综合分析题没有案例背景  
**原因**: 案例被错误放在前一题，清洗时被删除  
**永久方案**: 提取 + 传递

```typescript
// 提取案例
if (afterMarker.startsWith('案例：')) {
  caseContent = afterMarker;
}

// 传递给下一题
if (extractedCase && q.number === 101) {
  content = extractedCase + '\n\n' + content;
}
```

**记住**: 
1. 不要简单删除案例，要提取保存
2. 综合分析题第一题（101/104/107）必须有案例

---

## 🚀 标准化导入流程（强制执行）

### ✅ 第1步：数据质量检查（必做）
```bash
# 运行上面的3个检查脚本
# 如果发现问题，记录下来
```

### ✅ 第2步：选择正确的导入脚本
```bash
# ❌ 不要用: import-xxx.ts（原始版，有bug）
# ✅ 必须用: import-xxx-FIXED.ts（修复版）

# 如果是新年份，复制修复版：
cp import-2023-zhongyao-yaoxue-yiyao-FIXED.ts import-2024-xxx-FIXED.ts
```

### ✅ 第3步：修改配置
```typescript
// 修改3处：
1. 年份: source_year: 2024
2. JSON路径: './shuju/2024年.../xxx.json'
3. 图片路径: './public/shuju/2024年.../img'
```

### ✅ 第4步：运行导入
```bash
npx tsx prisma/import-2024-xxx-FIXED.ts

# 观察日志，确认：
# ✅ 看到"提取案例"日志
# ✅ 看到"添加案例到题101"
# ✅ 看到"清洗：移除..."
# ✅ 看到"继承题xx的选项"
```

### ✅ 第5步：验证导入（必做）
```bash
# 1. 验证选项错位
npx tsx diagnose-option-mismatch.ts

# 2. 验证题目内容
npx tsx verify-question-100.ts

# 3. 验证案例内容
npx tsx check-q101-content.ts
```

### ✅ 第6步：前端测试（必做）
```bash
# 1. 重启服务器
npm run dev

# 2. 清除缓存
Ctrl+Shift+Delete

# 3. 测试关键题目
- 第40题: 只显示图片，不显示文字 ✅
- 第41-42题: 有完整选项 ✅
- 第43-44题: 选项内容正确 ✅
- 第91-93题: 有完整选项 ✅
- 第100题: 内容干净，不超过20字符 ✅
- 第101题: 有完整案例背景 ✅
```

---

## ⚠️ 常见错误及避免方法

### 错误1: 使用原始导入脚本
```bash
❌ 错误: npx tsx prisma/import-xxx.ts
✅ 正确: npx tsx prisma/import-xxx-FIXED.ts
```

### 错误2: 不检查JSON数据质量
```bash
❌ 错误: 直接导入，发现问题再修复
✅ 正确: 导入前运行检查脚本，提前发现问题
```

### 错误3: 不验证导入结果
```bash
❌ 错误: 导入完成就认为成功了
✅ 正确: 必须运行验证脚本 + 前端实际测试
```

### 错误4: 忽略导入日志
```bash
❌ 错误: 看到"成功120道"就认为没问题
✅ 正确: 检查是否有"清洗"、"提取案例"、"继承选项"等日志
```

---

## 📝 关键文件清单

### 必用文件
- ✅ `prisma/import-2023-zhongyao-yaoxue-yiyao-FIXED.ts` - 修复版导入脚本（模板）

### 验证脚本
- ✅ `diagnose-option-mismatch.ts` - 选项错位诊断
- ✅ `verify-question-100.ts` - 题目内容验证
- ✅ `check-q101-content.ts` - 案例内容验证

### 参考文档
- ✅ `🎯历年真题导入终极解决方案-完整记录.md` - 详细技术文档
- ✅ `📋2023年历年真题导入问题总结-完整版.md` - 问题总结
- ✅ `🔥下次导入必读-避免重复7-8遍.md` - 本文档

---

## 💡 为什么会重复7-8遍

### 之前的错误做法
1. ❌ 发现问题 → 手动修改JSON → 重新导入
2. ❌ 只修复表面问题，不分析根本原因
3. ❌ 修复一个问题，又暴露另一个问题
4. ❌ 没有系统化方案，每次从头排查
5. ❌ 没有验证机制，问题反复出现

### 现在的正确做法
1. ✅ 导入前检查数据质量
2. ✅ 使用修复版脚本（包含所有5个问题的解决方案）
3. ✅ 观察导入日志，确认修复生效
4. ✅ 运行验证脚本，检查关键题目
5. ✅ 前端实际测试，确保显示正确

---

## 🎯 下次导入30分钟完成清单

```
□ 00:00 - 准备JSON和图片文件
□ 00:05 - 运行3个数据质量检查脚本
□ 00:10 - 复制修复版导入脚本，修改配置
□ 00:15 - 运行导入，观察日志
□ 00:20 - 运行3个验证脚本
□ 00:25 - 前端测试6个关键题目
□ 00:30 - 完成✅

如果超过30分钟，说明：
1. 没有使用修复版脚本
2. JSON数据质量太差，需要手动修复
3. 出现了新的问题（需要分析并更新方案）
```

---

## 🔥 最重要的3件事

### 1. 永远使用修复版导入脚本
```bash
import-xxx-FIXED.ts  # ✅ 修复版
import-xxx.ts        # ❌ 原始版（有bug）
```

### 2. 导入前必须检查数据质量
```bash
# 3个检查脚本（见顶部）
# 发现问题 → 记录 → 确认修复版脚本能处理
```

### 3. 导入后必须全面验证
```bash
# 3个验证脚本 + 6个关键题目前端测试
# 不验证 = 问题隐藏，后面爆发
```

---

## 🎊 成功标志

当你看到：

✅ 导入日志有"提取案例"、"清洗"、"继承选项"  
✅ 验证脚本全部通过  
✅ 前端6个关键题目全部正常  
✅ 所有题目都有选项，都有内容  
✅ 综合分析题都有案例背景  

**恭喜！你成功了！不会再重复7-8遍了！** 🎉

---

## 📞 如果还是出问题

1. 检查是否使用了修复版脚本（文件名必须有FIXED）
2. 检查JSON数据质量（运行检查脚本）
3. 查看导入日志（是否有清洗、提取、继承的日志）
4. 运行验证脚本（定位具体哪个题目有问题）
5. 查看完整技术文档（`🎯历年真题导入终极解决方案-完整记录.md`）

**记住：系统已经保存了所有解决方案，不要重新发明轮子！**
