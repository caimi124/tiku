# ğŸš€ å¿«é€Ÿå¼€å§‹ - å®Œæ•´é…ç½®æŒ‡å—

## ğŸ“‹ æ€»è§ˆ

æœ¬æŒ‡å—å°†å¸®ä½ å®Œæˆä»¥ä¸‹é…ç½®ï¼š
1. âœ… åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨ï¼ˆ13ä¸ªè¡¨ï¼‰
2. âœ… é…ç½®æ–‡ä»¶å­˜å‚¨ï¼ˆ3ä¸ªbucketsï¼‰
3. âœ… è®¾ç½®å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰
4. âœ… å¯¼å…¥åˆå§‹æ•°æ®
5. âœ… éªŒè¯é…ç½®

**é¢„è®¡æ—¶é—´ï¼š15-20åˆ†é’Ÿ**

---

## ğŸ¯ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰

### 1.1 æ‰“å¼€ SQL Editor

1. **è®¿é—® Supabase Dashboard**
   ```
   https://supabase.com/dashboard/project/tparjdkxxtnentsdazfw
   ```

2. **ç‚¹å‡»å·¦ä¾§èœå• "SQL Editor"**

3. **ç‚¹å‡»å³ä¸Šè§’ "New query" æŒ‰é’®**

### 1.2 è¿è¡Œå»ºè¡¨è„šæœ¬

1. **æ‰“å¼€æ–‡ä»¶ï¼š`01-åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨.sql`**

2. **å¤åˆ¶å…¨éƒ¨å†…å®¹ï¼ˆCtrl+A, Ctrl+Cï¼‰**

3. **ç²˜è´´åˆ° SQL Editorï¼ˆCtrl+Vï¼‰**

4. **ç‚¹å‡»å³ä¸‹è§’ç»¿è‰² "Run" æŒ‰é’®**
   - æˆ–æŒ‰ **Ctrl+Enter** å¿«æ·é”®

5. **ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆçº¦10-15ç§’ï¼‰**

### 1.3 éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

æ‰§è¡Œå®Œæˆåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
âœ… Success. Rows returned.
```

åœ¨ç»“æœä¸­ä½ ä¼šçœ‹åˆ°æ‰€æœ‰åˆ›å»ºçš„è¡¨åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
- questions
- institutions
- prediction_papers
- knowledge_points
- user_profiles
- user_answers
- study_plans
- user_assessments
- pdf_resources
- ai_generated_questions
- wrong_questions
- daily_stats
- system_configs

**å¦‚æœçœ‹åˆ° âœ… Success å’Œè¡¨åˆ—è¡¨ï¼Œè¯´æ˜åˆ›å»ºæˆåŠŸï¼**

---

## ğŸ¯ ç¬¬äºŒæ­¥ï¼šé…ç½® Storage Bucketsï¼ˆ5åˆ†é’Ÿï¼‰

### 2.1 è®¿é—® Storage é¡µé¢

1. **ç‚¹å‡»å·¦ä¾§èœå• "Storage"**

2. **ä½ ä¼šçœ‹åˆ° Storage ç®¡ç†ç•Œé¢**

### 2.2 åˆ›å»º pdfs Bucket

1. **ç‚¹å‡»å³ä¸Šè§’ "New bucket" æŒ‰é’®**

2. **å¡«å†™ä¿¡æ¯ï¼š**
   ```
   Name: pdfs
   Public bucket: âœ“ å‹¾é€‰
   ```

3. **ç‚¹å‡» "Create bucket"**

4. **è¿›å…¥ pdfs bucketï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ï¼š**
   - ç‚¹å‡» "Create folder"
   - åˆ†åˆ«åˆ›å»ºï¼š`chapters`, `highlights`, `outlines`, `predictions`, `thumbnails`

### 2.3 åˆ›å»º avatars Bucket

1. **ç‚¹å‡»å·¦ä¸Šè§’ "All buckets" è¿”å›**

2. **ç‚¹å‡» "New bucket"**

3. **å¡«å†™ä¿¡æ¯ï¼š**
   ```
   Name: avatars
   Public bucket: âœ“ å‹¾é€‰
   File size limit: 5000000 (5MBï¼Œå¯é€‰)
   ```

4. **ç‚¹å‡» "Create bucket"**

### 2.4 åˆ›å»º institution-logos Bucket

1. **ç‚¹å‡» "New bucket"**

2. **å¡«å†™ä¿¡æ¯ï¼š**
   ```
   Name: institution-logos
   Public bucket: âœ“ å‹¾é€‰
   File size limit: 2000000 (2MBï¼Œå¯é€‰)
   ```

3. **ç‚¹å‡» "Create bucket"**

### 2.5 é…ç½® Storage ç­–ç•¥

1. **è¿”å› SQL Editor**

2. **åˆ›å»ºæ–°æŸ¥è¯¢ï¼ˆNew queryï¼‰**

3. **è¿è¡Œä»¥ä¸‹ SQLï¼š**

```sql
-- Storage Buckets RLS ç­–ç•¥é…ç½®

-- pdfs bucket ç­–ç•¥
CREATE POLICY "Public read pdfs"
ON storage.objects FOR SELECT
USING (bucket_id = 'pdfs');

CREATE POLICY "Authenticated upload pdfs"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'pdfs' AND auth.role() = 'authenticated');

-- avatars bucket ç­–ç•¥
CREATE POLICY "Public read avatars"
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

CREATE POLICY "Users manage own avatar"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'avatars' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- logos bucket ç­–ç•¥
CREATE POLICY "Public read logos"
ON storage.objects FOR SELECT
USING (bucket_id = 'institution-logos');

CREATE POLICY "Authenticated upload logos"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'institution-logos' AND auth.role() = 'authenticated');
```

4. **ç‚¹å‡» "Run" æ‰§è¡Œ**

5. **çœ‹åˆ°æˆåŠŸæ¶ˆæ¯å³å¯**

---

## ğŸ¯ ç¬¬ä¸‰æ­¥ï¼šå¯¼å…¥åˆå§‹æ•°æ®ï¼ˆ3åˆ†é’Ÿï¼‰

### 3.1 å¯¼å…¥2024å¹´çœŸé¢˜

1. **åœ¨ SQL Editor åˆ›å»ºæ–°æŸ¥è¯¢**

2. **æ‰“å¼€æ–‡ä»¶ï¼š`å¯¼å…¥çœŸé¢˜åˆ°tiku2-SQLè„šæœ¬.sql`**

3. **å¤åˆ¶å†…å®¹å¹¶ç²˜è´´åˆ° SQL Editor**

4. **ç‚¹å‡» "Run" æ‰§è¡Œ**

5. **ç¡®è®¤å¯¼å…¥æˆåŠŸï¼š**
   ```
   total_questions: 3
   questions_2024: 3
   zhongyao_questions: 3
   ```

### 3.2 æ·»åŠ ç¤ºä¾‹æœºæ„æ•°æ®

åœ¨ SQL Editor è¿è¡Œï¼š

```sql
-- æ’å…¥ç¤ºä¾‹åŸ¹è®­æœºæ„
INSERT INTO institutions (id, name, description, total_predictions, correct_predictions, accuracy_rate, reputation_score, is_verified)
VALUES 
  ('inst_huatu', 'åå›¾æ•™è‚²', 'ä¸“ä¸šåŒ»è¯è€ƒè¯•åŸ¹è®­æœºæ„', 120, 95, 79.17, 4.5, true),
  ('inst_zhonggong', 'ä¸­å…¬æ•™è‚²', 'ç»¼åˆèŒä¸šæ•™è‚²åŸ¹è®­', 100, 72, 72.00, 4.2, true),
  ('inst_xinhuayi', 'æ–°ååŒ»è€ƒ', 'åŒ»è¯ä¸“ä¸šè€ƒè¯•åŸ¹è®­', 80, 68, 85.00, 4.7, true)
ON CONFLICT (id) DO NOTHING;

-- éªŒè¯æ’å…¥
SELECT id, name, accuracy_rate, reputation_score FROM institutions;
```

### 3.3 æ·»åŠ çŸ¥è¯†ç‚¹æ•°æ®

```sql
-- æ’å…¥ç¤ºä¾‹çŸ¥è¯†ç‚¹
INSERT INTO knowledge_points (id, exam_type, subject, chapter, point_name, importance_level, frequency)
VALUES 
  ('kp_001', 'æ‰§ä¸šè¯å¸ˆ', 'ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½', 'ä¸­åŒ»åŸºç¡€ç†è®º', 'ç»ç»œå­¦è¯´', 5, 15),
  ('kp_002', 'æ‰§ä¸šè¯å¸ˆ', 'ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½', 'ä¸­è¯è´®è—ä¸å…»æŠ¤', 'ä¸­è¯è´®è—åè¯', 4, 12),
  ('kp_003', 'æ‰§ä¸šè¯å¸ˆ', 'ä¸­è¯å­¦ç»¼åˆçŸ¥è¯†ä¸æŠ€èƒ½', 'ä¸­è¯è°ƒå‰‚', 'ç…è¯å®¤ç®¡ç†è§„èŒƒ', 4, 10)
ON CONFLICT (id) DO NOTHING;

-- éªŒè¯æ’å…¥
SELECT id, point_name, importance_level, frequency FROM knowledge_points;
```

---

## ğŸ¯ ç¬¬å››æ­¥ï¼šéªŒè¯é…ç½®ï¼ˆ2åˆ†é’Ÿï¼‰

### 4.1 éªŒè¯æ•°æ®åº“è¡¨

åœ¨ SQL Editor è¿è¡Œï¼š

```sql
-- 1. æŸ¥çœ‹æ‰€æœ‰è¡¨
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_type = 'BASE TABLE'
ORDER BY table_name;

-- 2. æŸ¥çœ‹é¢˜ç›®æ•°æ®
SELECT COUNT(*) as total,
       COUNT(*) FILTER (WHERE '2024å¹´çœŸé¢˜' = ANY(knowledge_points)) as questions_2024
FROM questions;

-- 3. æŸ¥çœ‹æœºæ„æ•°æ®
SELECT name, accuracy_rate, reputation_score FROM institutions;

-- 4. æŸ¥çœ‹Storageé…ç½®
SELECT 
  bucket_id,
  COUNT(*) as policy_count
FROM (
  SELECT DISTINCT 
    (regexp_matches(qual, 'bucket_id = ''([^'']+)''', 'g'))[1] as bucket_id
  FROM pg_policies
  WHERE tablename = 'objects'
) policies
GROUP BY bucket_id;
```

**é¢„æœŸç»“æœï¼š**
- âœ… çœ‹åˆ°13ä¸ªè¡¨
- âœ… é¢˜ç›®æ€»æ•°ï¼š3ï¼Œ2024å¹´çœŸé¢˜ï¼š3
- âœ… æœºæ„æ•°æ®ï¼š3æ¡
- âœ… Storageç­–ç•¥ï¼šæ¯ä¸ªbucketè‡³å°‘1æ¡

### 4.2 éªŒè¯ Storage Buckets

1. **ç‚¹å‡»å·¦ä¾§èœå• "Storage"**

2. **ç¡®è®¤çœ‹åˆ°3ä¸ªbucketsï¼š**
   - âœ… pdfs
   - âœ… avatars
   - âœ… institution-logos

3. **è¿›å…¥ pdfs bucket**

4. **ç¡®è®¤çœ‹åˆ°5ä¸ªæ–‡ä»¶å¤¹ï¼š**
   - âœ… chapters
   - âœ… highlights
   - âœ… outlines
   - âœ… predictions
   - âœ… thumbnails

### 4.3 æµ‹è¯• API è¿æ¥

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
npx tsx test-api-connection.ts
```

**é¢„æœŸç»“æœï¼š**
```
âœ… API è¿æ¥æ­£å¸¸
âœ… questions è¡¨å­˜åœ¨
ğŸ“š é¢˜åº“æ€»æ•°: 3 é“é¢˜ç›®
ğŸ”¥ 2024å¹´çœŸé¢˜: 3 é“
```

---

## ğŸ¯ ç¬¬äº”æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆ1åˆ†é’Ÿï¼‰

### 5.1 æ›´æ–° .env.local

åˆ›å»ºæˆ–æ›´æ–° `e:\tiku\.env.local` æ–‡ä»¶ï¼š

```env
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://tparjdkxxtnentsdazfw.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwYXJqZGt4eHRuZW50c2RhemZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxODEwMzgsImV4cCI6MjA3ODc1NzAzOH0.2P5_CUnHErcTTTC2-LZo1tqFaq0ps0g-kpglqS45Y5s

# æ•°æ®åº“è¿æ¥ï¼ˆå¯é€‰ï¼Œç”¨äºPrismaï¼‰
DATABASE_URL=postgresql://postgres:bdcW5inRuvSMfwYN@db.tparjdkxxtnentsdazfw.supabase.co:5432/postgres

# NextAuth é…ç½®
NEXTAUTH_SECRET=your-secret-key-change-this-in-production
NEXTAUTH_URL=http://localhost:3000

# OpenAI APIï¼ˆç”¨äºAIåŠŸèƒ½ï¼‰
OPENAI_API_KEY=sk-your-openai-api-key-here

# ç¯å¢ƒæ ‡è¯†
NODE_ENV=development
```

### 5.2 è·å– Service Role Keyï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åœ¨æœåŠ¡ç«¯æ“ä½œï¼ˆç»•è¿‡RLSï¼‰ï¼š

1. **åœ¨ Dashboard ç‚¹å‡»å·¦ä¾§ "Settings"**

2. **ç‚¹å‡» "API"**

3. **æ‰¾åˆ° "service_role" key**

4. **å¤åˆ¶å¹¶æ·»åŠ åˆ° .env.localï¼ˆä¸è¦æäº¤åˆ°Gitï¼‰ï¼š**
   ```env
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```

---

## âœ… é…ç½®å®Œæˆæ£€æŸ¥æ¸…å•

### æ•°æ®åº“è¡¨
- [ ] 13ä¸ªè¡¨å…¨éƒ¨åˆ›å»ºæˆåŠŸ
- [ ] è§¦å‘å™¨é…ç½®æˆåŠŸ
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] åˆå§‹é…ç½®æ•°æ®æ’å…¥

### Storage
- [ ] pdfs bucket åˆ›å»ºï¼ˆå«5ä¸ªæ–‡ä»¶å¤¹ï¼‰
- [ ] avatars bucket åˆ›å»º
- [ ] institution-logos bucket åˆ›å»º
- [ ] Storage RLS ç­–ç•¥é…ç½®

### åˆå§‹æ•°æ®
- [ ] 3é“2024å¹´çœŸé¢˜å¯¼å…¥
- [ ] 3ä¸ªç¤ºä¾‹æœºæ„æ•°æ®
- [ ] 3ä¸ªç¤ºä¾‹çŸ¥è¯†ç‚¹æ•°æ®

### ç¯å¢ƒé…ç½®
- [ ] .env.local æ–‡ä»¶åˆ›å»º
- [ ] Supabase URL å’Œ Key é…ç½®
- [ ] æµ‹è¯•è„šæœ¬è¿è¡ŒæˆåŠŸ

---

## ğŸ‰ é…ç½®æˆåŠŸï¼ä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼Ÿ

### ç«‹å³å¯åš

1. **æµ‹è¯•å‰ç«¯æ˜¾ç¤º**
   ```bash
   npm run dev
   ```
   è®¿é—®ï¼šhttp://localhost:3000/practice

2. **ä¸Šä¼ ç¬¬ä¸€ä¸ªPDF**
   - åœ¨ Dashboard Storage ä¸­ä¸Šä¼ PDF
   - æµ‹è¯•åœ¨çº¿é¢„è§ˆ

3. **åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·**
   - æµ‹è¯•æ³¨å†Œç™»å½•åŠŸèƒ½
   - æµ‹è¯•ç­”é¢˜åŠŸèƒ½

### å¼€å‘ä»»åŠ¡

æ ¹æ® `ğŸ“é¡¹ç›®æŠ€æœ¯æ¶æ„å»ºè®®.md` ä¸­çš„å¼€å‘è·¯çº¿å›¾ï¼š

**æœ¬å‘¨ä»»åŠ¡ï¼š**
- [ ] å®Œå–„é¢˜åº“æŸ¥è¯¢API
- [ ] å®ç°ç”¨æˆ·ç­”é¢˜åŠŸèƒ½
- [ ] å¼€å‘PDFé¢„è§ˆç»„ä»¶
- [ ] å®ç°ç­”é¢˜ç»Ÿè®¡

**æœ¬æœˆä»»åŠ¡ï¼š**
- [ ] é›†æˆOpenAI API
- [ ] å®ç°æ™ºèƒ½è¯„ä¼°
- [ ] å¼€å‘æœºæ„åˆ†æåŠŸèƒ½
- [ ] AIç”Ÿæˆé¢˜ç›®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

åˆ›å»ºçš„é…ç½®æ–‡æ¡£ï¼š
- `01-åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨.sql` - å®Œæ•´å»ºè¡¨è„šæœ¬
- `02-é…ç½®Storage-BucketsæŒ‡å—.md` - Storageé…ç½®è¯¦è§£
- `ğŸ“é¡¹ç›®æŠ€æœ¯æ¶æ„å»ºè®®.md` - å®Œæ•´æŠ€æœ¯æ¶æ„
- `ğŸ”è¿æ¥é—®é¢˜å®Œæ•´è¯Šæ–­æŠ¥å‘Š.md` - ç½‘ç»œé—®é¢˜è¯Šæ–­

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: SQLæ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
**A:** 
- æ£€æŸ¥è¯­æ³•é”™è¯¯æç¤º
- ç¡®è®¤æ˜¯å¦æœ‰å†²çªçš„è¡¨å
- å°è¯•åˆ†æ®µæ‰§è¡ŒSQL
- æŸ¥çœ‹ Dashboard æ—¥å¿—

### Q2: Storage bucket åˆ›å»ºå¤±è´¥ï¼Ÿ
**A:**
- æ£€æŸ¥bucketåç§°æ˜¯å¦åˆæ³•
- ç¡®è®¤æ²¡æœ‰é‡å¤åç§°
- åˆ·æ–°é¡µé¢é‡è¯•

### Q3: RLSç­–ç•¥ä¸ç”Ÿæ•ˆï¼Ÿ
**A:**
- åœ¨SQL EditoræŸ¥è¯¢ç­–ç•¥ï¼š
  ```sql
  SELECT * FROM pg_policies WHERE tablename = 'objects';
  ```
- ç¡®è®¤ç­–ç•¥åç§°æ²¡æœ‰å†²çª
- é‡æ–°æ‰§è¡Œç­–ç•¥SQL

### Q4: APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼Ÿ
**A:**
- æ£€æŸ¥ .env.local é…ç½®
- ç¡®è®¤ Supabase URL å’Œ Key æ­£ç¡®
- è¿è¡Œï¼š`npm install @supabase/supabase-js`
- æŸ¥çœ‹ç½‘ç»œè¿æ¥

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

é‡åˆ°é—®é¢˜è¯·ï¼š
1. æŸ¥çœ‹ Dashboard çš„æ—¥å¿—
2. æ£€æŸ¥ SQL é”™è¯¯ä¿¡æ¯
3. è¿è¡Œæµ‹è¯•è„šæœ¬è¯Šæ–­
4. å‘Šè¯‰æˆ‘å…·ä½“çš„é”™è¯¯ä¿¡æ¯

**å‡†å¤‡å¥½å¼€å§‹å¼€å‘äº†ï¼** ğŸš€

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æµ‹è¯•APIè¿æ¥
npx tsx test-api-connection.ts

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# è¿è¡Œå‰ç«¯ä¿®å¤
.\åº”ç”¨å‰ç«¯ä¿®å¤.bat

# æŸ¥çœ‹é¡¹ç›®çŠ¶æ€
git status
```

---

**æ­å–œï¼é…ç½®å®Œæˆã€‚ç°åœ¨å¯ä»¥å¼€å§‹å¼€å‘ä½ çš„æ‰§ä¸šè¯å¸ˆé¢˜åº“å¹³å°äº†ï¼** ğŸŠ
