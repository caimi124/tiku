<!DOCTYPE html>
<html>
<head>
    <title>2022å¹´æ•°æ®å®æ—¶è¯Šæ–­</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        .test-section { margin: 20px 0; padding: 20px; background: #f9f9f9; border-left: 4px solid #2196F3; }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .info { color: #2196F3; }
        pre { background: #263238; color: #aed581; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stat-value { font-size: 36px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .log { max-height: 400px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .log-entry { padding: 5px; border-bottom: 1px solid #eee; }
        .log-entry.error { background: #ffebee; }
        .log-entry.success { background: #e8f5e9; }
        .log-entry.info { background: #e3f2fd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” 2022å¹´ä¸­è¯è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰å®æ—¶è¯Šæ–­ç³»ç»Ÿ</h1>
        
        <div class="stats" id="stats"></div>
        
        <div class="test-section">
            <h2>ğŸ“¡ å®æ—¶è¯Šæ–­</h2>
            <button onclick="runDiagnosis()" id="diagnosisBtn">å¼€å§‹å®Œæ•´è¯Šæ–­</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="openPracticePage()">æ‰“å¼€ç»ƒä¹ é¡µé¢</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h2>
            <div id="log" class="log"></div>
        </div>
        
        <div class="test-section" id="results"></div>
    </div>

    <script>
        const YEAR = 2022;
        const SUBJECT = 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰';
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push({ timestamp, message, type });
            updateLogDisplay();
            console.log(`[${type}] ${message}`);
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = logEntries.map(entry => 
                `<div class="log-entry ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        function updateStats(stats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = Object.entries(stats).map(([label, value]) => `
                <div class="stat-card">
                    <div class="stat-value">${value}</div>
                    <div class="stat-label">${label}</div>
                </div>
            `).join('');
        }

        function openPracticePage() {
            window.open(`/practice/history/${YEAR}?subject=${encodeURIComponent(SUBJECT)}`, '_blank');
        }

        async function runDiagnosis() {
            const btn = document.getElementById('diagnosisBtn');
            btn.disabled = true;
            btn.textContent = 'è¯Šæ–­ä¸­...';
            
            clearLog();
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­æµç¨‹', 'info');
            
            try {
                // æµ‹è¯•1: APIåŸºç¡€æµ‹è¯•
                log('=== æµ‹è¯•1: APIåŸºç¡€è¿æ¥ ===', 'info');
                const basicTest = await fetch('/api/questions?limit=1');
                const basicData = await basicTest.json();
                if (basicData.success) {
                    log('âœ… APIåŸºç¡€è¿æ¥æ­£å¸¸', 'success');
                } else {
                    log('âŒ APIåŸºç¡€è¿æ¥å¤±è´¥', 'error');
                }

                // æµ‹è¯•2: æŸ¥è¯¢2022å¹´æ•°æ®
                log('=== æµ‹è¯•2: æŸ¥è¯¢2022å¹´æ•°æ® ===', 'info');
                const url = `/api/questions?sourceYear=${YEAR}&subject=${encodeURIComponent(SUBJECT)}&limit=200`;
                log(`è¯·æ±‚URL: ${url}`, 'info');
                
                const response = await fetch(url);
                log(`å“åº”çŠ¶æ€ç : ${response.status}`, 'info');
                
                const data = await response.json();
                log(`å“åº”success: ${data.success}`, 'info');
                
                if (!data.success) {
                    log(`âŒ APIè¿”å›å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    throw new Error(data.error || 'APIè°ƒç”¨å¤±è´¥');
                }

                const total = data.data.total;
                const questionsCount = data.data.questions.length;
                
                log(`æ•°æ®åº“æ€»æ•°: ${total}`, 'info');
                log(`è¿”å›é¢˜ç›®æ•°: ${questionsCount}`, 'info');

                updateStats({
                    'æ•°æ®åº“æ€»æ•°': total,
                    'è¿”å›é¢˜ç›®æ•°': questionsCount,
                    'å“åº”çŠ¶æ€': response.status,
                    'APIçŠ¶æ€': data.success ? 'æˆåŠŸ' : 'å¤±è´¥'
                });

                if (total === 0) {
                    log('âŒ é—®é¢˜ç¡®è®¤ï¼šæ•°æ®åº“ä¸­æ²¡æœ‰2022å¹´ä¸­è¯è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰çš„æ•°æ®ï¼', 'error');
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šéœ€è¦é‡æ–°å¯¼å…¥æ•°æ®', 'warning');
                    return;
                }

                if (questionsCount === 0) {
                    log('âŒ é—®é¢˜ç¡®è®¤ï¼šæ•°æ®åº“æœ‰æ•°æ®ä½†APIè¿”å›ç©ºæ•°ç»„ï¼', 'error');
                    log('ğŸ’¡ å¯èƒ½åŸå› ï¼šæŸ¥è¯¢æ¡ä»¶ä¸åŒ¹é…æˆ–APIè¿‡æ»¤é—®é¢˜', 'warning');
                    return;
                }

                log(`âœ… æˆåŠŸè·å– ${questionsCount} é“é¢˜ç›®`, 'success');

                // æµ‹è¯•3: éªŒè¯å­—æ®µ
                log('=== æµ‹è¯•3: éªŒè¯å­—æ®µæ˜ å°„ ===', 'info');
                const sampleQ = data.data.questions[0];
                const requiredFields = ['id', 'content', 'options', 'correctAnswer', 'chapter', 'subject', 'sourceYear', 'questionType'];
                
                let missingFields = [];
                requiredFields.forEach(field => {
                    if (sampleQ.hasOwnProperty(field)) {
                        log(`âœ… å­—æ®µ ${field} å­˜åœ¨`, 'success');
                    } else {
                        log(`âŒ å­—æ®µ ${field} ç¼ºå¤±ï¼`, 'error');
                        missingFields.push(field);
                    }
                });

                if (missingFields.length > 0) {
                    log(`âŒ ç¼ºå¤±å­—æ®µï¼š${missingFields.join(', ')}`, 'error');
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šéœ€è¦ä¿®å¤APIå­—æ®µæ˜ å°„', 'warning');
                    return;
                }

                // æµ‹è¯•4: éªŒè¯chapterå­—æ®µå€¼
                log('=== æµ‹è¯•4: éªŒè¯chapterå­—æ®µå€¼ ===', 'info');
                const chapterStats = {};
                data.data.questions.forEach(q => {
                    const chapter = q.chapter;
                    chapterStats[chapter] = (chapterStats[chapter] || 0) + 1;
                });

                log('ç« èŠ‚ç»Ÿè®¡:', 'info');
                Object.entries(chapterStats).forEach(([chapter, count]) => {
                    log(`  ${chapter}: ${count}é¢˜`, 'info');
                });

                // æµ‹è¯•5: æ¨¡æ‹Ÿå‰ç«¯åˆ†ç»„
                log('=== æµ‹è¯•5: æ¨¡æ‹Ÿå‰ç«¯åˆ†ç»„é€»è¾‘ ===', 'info');
                const grouped = {
                    'ä¸€ã€æœ€ä½³é€‰æ‹©é¢˜': [],
                    'äºŒã€é…ä¼é€‰æ‹©é¢˜': [],
                    'ä¸‰ã€ç»¼åˆåˆ†æé¢˜': [],
                    'å››ã€å¤šé¡¹é€‰æ‹©é¢˜': [],
                };

                let ungrouped = 0;
                data.data.questions.forEach(q => {
                    const chapter = q.chapter;
                    if (grouped[chapter]) {
                        grouped[chapter].push(q);
                    } else {
                        ungrouped++;
                        log(`âš ï¸  é¢˜ç›®æœªåŒ¹é…åˆ°åˆ†ç»„ï¼šchapter="${chapter}"`, 'warning');
                    }
                });

                log('åˆ†ç»„ç»“æœ:', 'info');
                let totalGrouped = 0;
                Object.entries(grouped).forEach(([chapter, questions]) => {
                    const count = questions.length;
                    totalGrouped += count;
                    if (count > 0) {
                        log(`âœ… ${chapter}: ${count}é¢˜`, 'success');
                    } else {
                        log(`âš ï¸  ${chapter}: 0é¢˜`, 'warning');
                    }
                });

                if (ungrouped > 0) {
                    log(`âŒ æœ‰ ${ungrouped} é¢˜æœªè¢«æ­£ç¡®åˆ†ç»„`, 'error');
                    log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥chapterå­—æ®µå€¼æ˜¯å¦åŒ¹é…å‰ç«¯é¢„æœŸ', 'warning');
                } else {
                    log(`âœ… æ‰€æœ‰ ${totalGrouped} é¢˜éƒ½è¢«æ­£ç¡®åˆ†ç»„`, 'success');
                }

                // æœ€ç»ˆæ€»ç»“
                log('=== è¯Šæ–­æ€»ç»“ ===', 'info');
                if (questionsCount > 0 && missingFields.length === 0 && ungrouped === 0) {
                    log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤º', 'success');
                    log('ğŸ’¡ å¦‚æœå‰ç«¯ä»ç„¶æ˜¾ç¤º"æš‚æ— æ•°æ®"ï¼Œè¯·å°è¯•ï¼š', 'info');
                    log('   1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜', 'info');
                    log('   2. å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+Rï¼‰', 'info');
                    log('   3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯', 'info');
                } else {
                    log('âš ï¸  å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šé¢çš„è¯¦ç»†æ—¥å¿—', 'warning');
                }

                // æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <h2>ğŸ“„ ç¤ºä¾‹é¢˜ç›®æ•°æ®</h2>
                    <pre>${JSON.stringify(sampleQ, null, 2)}</pre>
                    <h2>ğŸ“Š å®Œæ•´å“åº”æ•°æ®ï¼ˆå‰3é¢˜ï¼‰</h2>
                    <pre>${JSON.stringify(data.data.questions.slice(0, 3), null, 2)}</pre>
                `;

            } catch (error) {
                log(`ğŸ’¥ è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'é‡æ–°è¯Šæ–­';
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.onload = () => {
            log('ğŸ“± è¯Šæ–­ç³»ç»Ÿå·²å°±ç»ª', 'success');
            log('ğŸ‘‰ ç‚¹å‡»"å¼€å§‹å®Œæ•´è¯Šæ–­"æŒ‰é’®å¼€å§‹æ£€æŸ¥', 'info');
        };
    </script>
</body>
</html>
