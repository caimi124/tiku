<!DOCTYPE html>
<html>
<head>
    <title>å®Œæ•´è¯Šæ–­å’Œä¿®å¤å·¥å…·</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” 2022å¹´ä¸­è¯è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰å®Œæ•´è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>æ­¥éª¤1: APIåŸºç¡€æµ‹è¯•</h2>
        <button onclick="testBasicApi()">æµ‹è¯•APIè¿æ¥</button>
        <div id="api-test-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤2: æ•°æ®æŸ¥è¯¢æµ‹è¯•</h2>
        <button onclick="testDataQuery()">æŸ¥è¯¢2022å¹´æ•°æ®</button>
        <div id="data-query-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤3: å­—æ®µæ˜ å°„éªŒè¯</h2>
        <button onclick="testFieldMapping()">éªŒè¯å­—æ®µæ˜ å°„</button>
        <div id="field-mapping-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤4: å‰ç«¯åˆ†ç»„æ¨¡æ‹Ÿ</h2>
        <button onclick="testFrontendGrouping()">æ¨¡æ‹Ÿå‰ç«¯åˆ†ç»„</button>
        <div id="frontend-grouping-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤5: å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="full-test-result"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3003';
        const YEAR = 2022;
        const SUBJECT = 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆäºŒï¼‰';

        // æ­¥éª¤1: æµ‹è¯•APIè¿æ¥
        async function testBasicApi() {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/questions?limit=1`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<p class="success">âœ… APIè¿æ¥æ­£å¸¸</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ APIè¿”å›å¤±è´¥: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ APIè¿æ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ­¥éª¤2: æŸ¥è¯¢2022å¹´æ•°æ®
        async function testDataQuery() {
            const resultDiv = document.getElementById('data-query-result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æŸ¥è¯¢...</p>';
            
            try {
                const url = `${BASE_URL}/api/questions?sourceYear=${YEAR}&subject=${encodeURIComponent(SUBJECT)}&limit=5`;
                console.log('æŸ¥è¯¢URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('æŸ¥è¯¢ç»“æœ:', data);
                
                let html = `<p><strong>è¯·æ±‚URL:</strong> ${url}</p>`;
                html += `<p><strong>å“åº”çŠ¶æ€:</strong> ${response.status}</p>`;
                html += `<p><strong>æˆåŠŸ:</strong> ${data.success}</p>`;
                
                if (data.success) {
                    html += `<p class="success"><strong>âœ… é¢˜ç›®æ€»æ•°:</strong> ${data.data.total}</p>`;
                    html += `<p><strong>è¿”å›é¢˜ç›®æ•°:</strong> ${data.data.questions.length}</p>`;
                    
                    if (data.data.total === 0) {
                        html += `<p class="error">âŒ é—®é¢˜ï¼šæ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ï¼</p>`;
                    } else if (data.data.questions.length === 0) {
                        html += `<p class="error">âŒ é—®é¢˜ï¼šæŸ¥è¯¢åˆ°æ€»æ•°ä½†æ²¡æœ‰è¿”å›é¢˜ç›®ï¼</p>`;
                    } else {
                        html += `<p class="success">âœ… æ•°æ®æŸ¥è¯¢æ­£å¸¸</p>`;
                    }
                } else {
                    html += `<p class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${data.error}</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ­¥éª¤3: éªŒè¯å­—æ®µæ˜ å°„
        async function testFieldMapping() {
            const resultDiv = document.getElementById('field-mapping-result');
            resultDiv.innerHTML = '<p>æ­£åœ¨éªŒè¯...</p>';
            
            try {
                const url = `${BASE_URL}/api/questions?sourceYear=${YEAR}&subject=${encodeURIComponent(SUBJECT)}&limit=3`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success || data.data.questions.length === 0) {
                    resultDiv.innerHTML = `<p class="error">âŒ æ— æ³•è·å–æ•°æ®è¿›è¡ŒéªŒè¯</p>`;
                    return;
                }
                
                const sampleQuestion = data.data.questions[0];
                const requiredFields = ['id', 'content', 'options', 'correctAnswer', 'chapter', 'subject', 'sourceYear', 'questionType'];
                
                let html = '<h3>å­—æ®µéªŒè¯ç»“æœï¼š</h3><ul>';
                let allFieldsPresent = true;
                
                requiredFields.forEach(field => {
                    const hasField = sampleQuestion.hasOwnProperty(field);
                    if (hasField) {
                        html += `<li class="success">âœ… ${field}: ${typeof sampleQuestion[field] === 'string' ? sampleQuestion[field].substring(0, 50) : typeof sampleQuestion[field]}</li>`;
                    } else {
                        html += `<li class="error">âŒ ${field}: ç¼ºå¤±ï¼</li>`;
                        allFieldsPresent = false;
                    }
                });
                
                html += '</ul>';
                
                if (allFieldsPresent) {
                    html += '<p class="success">âœ… æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨</p>';
                } else {
                    html += '<p class="error">âŒ å­˜åœ¨ç¼ºå¤±å­—æ®µï¼Œéœ€è¦ä¿®å¤APIæ˜ å°„</p>';
                }
                
                html += '<h3>å®Œæ•´é¢˜ç›®æ•°æ®ï¼š</h3>';
                html += `<pre>${JSON.stringify(sampleQuestion, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ éªŒè¯å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ­¥éª¤4: æ¨¡æ‹Ÿå‰ç«¯åˆ†ç»„
        async function testFrontendGrouping() {
            const resultDiv = document.getElementById('frontend-grouping-result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
            
            try {
                const url = `${BASE_URL}/api/questions?sourceYear=${YEAR}&subject=${encodeURIComponent(SUBJECT)}&limit=200`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success || data.data.questions.length === 0) {
                    resultDiv.innerHTML = `<p class="error">âŒ æ— æ³•è·å–æ•°æ®è¿›è¡Œæµ‹è¯•</p>`;
                    return;
                }
                
                // æ¨¡æ‹Ÿå‰ç«¯åˆ†ç»„é€»è¾‘
                const grouped = {
                    'ä¸€ã€æœ€ä½³é€‰æ‹©é¢˜': [],
                    'äºŒã€é…ä¼é€‰æ‹©é¢˜': [],
                    'ä¸‰ã€ç»¼åˆåˆ†æé¢˜': [],
                    'å››ã€å¤šé¡¹é€‰æ‹©é¢˜': [],
                };
                
                data.data.questions.forEach(q => {
                    const chapter = q.chapter;
                    if (grouped[chapter]) {
                        grouped[chapter].push(q);
                    } else {
                        console.warn('æœªåŒ¹é…çš„ç« èŠ‚:', chapter);
                    }
                });
                
                let html = '<h3>åˆ†ç»„ç»“æœï¼š</h3><ul>';
                let totalGrouped = 0;
                
                Object.entries(grouped).forEach(([chapter, questions]) => {
                    const count = questions.length;
                    totalGrouped += count;
                    if (count > 0) {
                        html += `<li class="success">âœ… ${chapter}: ${count}é¢˜</li>`;
                    } else {
                        html += `<li class="warning">âš ï¸ ${chapter}: 0é¢˜</li>`;
                    }
                });
                
                html += '</ul>';
                html += `<p><strong>æ€»è®¡:</strong> ${totalGrouped} / ${data.data.total} é¢˜è¢«æ­£ç¡®åˆ†ç»„</p>`;
                
                if (totalGrouped === data.data.total) {
                    html += '<p class="success">âœ… æ‰€æœ‰é¢˜ç›®éƒ½è¢«æ­£ç¡®åˆ†ç»„</p>';
                } else {
                    html += `<p class="error">âŒ æœ‰ ${data.data.total - totalGrouped} é¢˜æœªè¢«åˆ†ç»„</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ­¥éª¤5: è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const resultDiv = document.getElementById('full-test-result');
            resultDiv.innerHTML = '<h3>æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...</h3>';
            
            const tests = [
                { name: 'APIè¿æ¥æµ‹è¯•', func: testBasicApi },
                { name: 'æ•°æ®æŸ¥è¯¢æµ‹è¯•', func: testDataQuery },
                { name: 'å­—æ®µæ˜ å°„éªŒè¯', func: testFieldMapping },
                { name: 'å‰ç«¯åˆ†ç»„æµ‹è¯•', func: testFrontendGrouping }
            ];
            
            for (const test of tests) {
                resultDiv.innerHTML += `<p>æ­£åœ¨æ‰§è¡Œ: ${test.name}...</p>`;
                await test.func();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            resultDiv.innerHTML += '<h3 class="success">âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªæµ‹è¯•ç»“æœã€‚</h3>';
            resultDiv.innerHTML += `<p><a href="${BASE_URL}/practice/history/${YEAR}?subject=${encodeURIComponent(SUBJECT)}" target="_blank">ğŸ‘‰ ç‚¹å‡»è¿™é‡Œè®¿é—®å®é™…é¡µé¢</a></p>`;
        }
    </script>
</body>
</html>
