/**
 * æ‰‹åŠ¨æ£€æŸ¥å¹¶æ›´æ–°æŒ‡å®šç« èŠ‚çš„å°èŠ‚å†…å®¹
 */

import { createClient } from '@supabase/supabase-js'
import { config } from 'dotenv'

config({ path: '.env.local' })
config({ path: '.env' })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://tparjdkxxtnentsdazfw.supabase.co'
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwYXJqZGt4eHRuZW50c2RhemZ3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzE4MTAzOCwiZXhwIjoyMDc4NzU3MDM4fQ.i0nA_AOLnBdeK7chICmeltFchkdJmYKMVqVxu8IaofE'

const supabase = createClient(supabaseUrl, supabaseKey)
const subjectCode = 'xiyao_yaoxue_er'

// éœ€è¦æ£€æŸ¥çš„å°èŠ‚åŠå…¶å¯èƒ½çš„æ›´æ–°å†…å®¹
const sectionsToUpdate: Record<string, {
  sectionCode: string
  sectionTitle: string
  currentPoints: number
  newPoints: Array<{
    title: string
    content: string
    importance?: number
  }>
}> = {
  'C1.1-ä¸­æ¢è‚Œæ¾è¯': {
    sectionCode: 'C1.1',
    sectionTitle: 'ç¬¬ä¸€èŠ‚ é•‡é™å‚¬çœ è¯ã€ä¸­æ¢è‚Œæ¾è¯',
    currentPoints: 1,
    newPoints: [
      {
        title: 'ç¬¬äºŒäºšç±» ä¸­æ¢è‚Œæ¾è¯ - è¯ç‰©åˆ†ç±»ä¸ä»£è¡¨è¯å“',
        content: `åˆ†ç±»ï¼š
1. éè‹¯äºŒæ°®ä“¬ç±»
   ä»£è¡¨è¯å“ï¼šä¹™å“Œç«‹æ¾ã€å·´æ°¯èŠ¬ã€æ°¯å”‘æ²™å®—ã€ç¾ä»–æ²™é…®

ä½œç”¨æœºåˆ¶ï¼š
ä¸­æ¢æ€§è‚Œè‚‰æ¾å¼›è¯é€šè¿‡å¯¹ä¸­æ¢ç¥ç»å¤šçªè§¦é€šé“äº§ç”Ÿä½œç”¨ï¼Œä»¥é˜»æ–­ç¥ç»å†²åŠ¨ç”µæ³¢ä¼ å¯¼ï¼Œä»è€Œäº§ç”Ÿè‚Œè‚‰æ¾å¼›æ•ˆåº”ã€‚æœ¬èŠ‚ä¸»è¦ä»‹ç»ä¸­æ¢æ€§è‚Œæ¾è¯ä¸­çš„éè‹¯äºŒæ°®ä“¬ç±»è¯ç‰©ã€‚

ä¸´åºŠç”¨è¯è¯„ä»·ï¼š
1. ä¹™å“Œç«‹æ¾ï¼šç”¨äºç¼“è§£è‚©å‘¨ç‚ã€è…°ç—›ç—‡ç­‰å¼•èµ·çš„è‚Œç´§å¼ çŠ¶æ€
2. å·´æ°¯èŠ¬ï¼šç”¨äºå¤šå‘æ€§ç¡¬åŒ–ç—‡æ‰€å¼•èµ·çš„ä¸¥é‡ä½†å¯é€†çš„è‚Œè‚‰ç—‰æŒ›
3. æ°¯å”‘æ²™å®—ï¼šç”¨äºå„ç§æ€¥ã€æ…¢æ€§è½¯ç»„ç»‡ï¼ˆè‚Œè‚‰ã€éŸ§å¸¦ã€ç­‹è†œï¼‰æ‰­ä¼¤ã€æŒ«ä¼¤ï¼Œè¿åŠ¨åè‚Œè‚‰é…¸ç—›ã€è‚Œè‚‰åŠ³æŸæ‰€å¼•èµ·çš„ç–¼ç—›
4. ç¾ä»–æ²™é…®ï¼šç”¨äºç¼“è§£æ€¥æ€§ã€ç–¼ç—›æ€§è‚Œè‚‰éª¨éª¼ç–¾ç—…å¼•èµ·çš„è‚Œè‚‰ç—‰æŒ›`,
        importance: 4,
      },
    ],
  },
  'C6.4': {
    sectionCode: 'C6.4',
    sectionTitle: 'ç¬¬å››èŠ‚ å‡ç™½ç»†èƒè¯',
    currentPoints: 1,
    newPoints: [
      {
        title: 'å‡ç™½ç»†èƒè¯çš„åˆ†ç±»ä¸ä»£è¡¨è¯å“',
        content: `åˆ†ç±»ï¼š
1. åˆºæ¿€å› å­ç±»
   ä»£è¡¨è¯å“ï¼šäººç²’ç»†èƒåˆºæ¿€å› å­ã€äººç²’ç»†èƒå·¨å™¬ç»†èƒåˆºæ¿€å› å­

2. å…¶ä»–å‡ç™½ç»†èƒè¯
   ä»£è¡¨è¯å“ï¼šè‚Œè‹·ã€åˆ©å¯å›ã€ç»´ç”Ÿç´ B4ï¼ˆè…ºå˜Œå‘¤ï¼‰ã€å°æª—èƒºã€é²¨è‚é†‡ã€è„±æ°§æ ¸è‹·é…¸é’ 

ä½œç”¨æœºåˆ¶ï¼š
1. åˆºæ¿€å› å­ç±»ï¼šåˆºæ¿€éª¨é«“é€ è¡€ï¼Œä¿ƒè¿›ä¸­æ€§ç²’ç»†èƒã€å•æ ¸ç»†èƒç­‰ç™½ç»†èƒçš„ç”Ÿæˆå’Œé‡Šæ”¾
2. å…¶ä»–å‡ç™½ç»†èƒè¯ï¼šé€šè¿‡ä¸åŒæœºåˆ¶ä¿ƒè¿›ç™½ç»†èƒç”Ÿæˆ

ä¸´åºŠç”¨è¯è¯„ä»·ï¼š
1. äººç²’ç»†èƒåˆºæ¿€å› å­ï¼š
   - ç”¨äºé˜²æ²»å„ç§åŸå› å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡ã€æ€¥æ€§ç²’ç»†èƒå‡å°‘ç—‡
   - å°¤å…¶é€‚ç”¨äºé˜²æ²»è‚¿ç˜¤æ”¾åŒ–ç–—å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡
   - å•ä¸€ç”¨è¯æ²»ç–—è‚¿ç˜¤æ”¾åŒ–ç–—å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡æ—¶ç–—ç¨‹è¾ƒé•¿ï¼Œå¯ä»¥ä¸å…¶ä»–å‡ç™½ç»†èƒè¯ç‰©è”åˆåº”ç”¨

2. è‚Œè‹·ï¼šç”¨äºæ€¥ã€æ…¢æ€§è‚ç‚ï¼Œç™½ç»†èƒå‡å°‘ç—‡ï¼Œè¡€å°æ¿å‡å°‘ç—‡åŠå†ç”Ÿéšœç¢æ€§è´«è¡€ç­‰çš„è¾…åŠ©æ²»ç–—

3. åˆ©å¯å›ï¼šç”¨äºé˜²æ²»å› åŒ–ç–—ã€æ”¾ç–—ã€è‹¯ä¸­æ¯’å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡

4. ç»´ç”Ÿç´ B4ï¼ˆè…ºå˜Œå‘¤ï¼‰ï¼šç”¨äºé˜²æ²»å„ç§åŸå› å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡

5. å°æª—èƒºï¼šç”¨äºé˜²æ²»è‚¿ç˜¤æ”¾åŒ–ç–—å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡

6. é²¨è‚é†‡ï¼šç”¨äºé˜²æ²»å› åŒ–ç–—ã€æ”¾ç–—ã€è‹¯ä¸­æ¯’å¼•èµ·çš„ç™½ç»†èƒå‡å°‘ç—‡

7. è„±æ°§æ ¸è‹·é…¸é’ ï¼šä¸ºå¤æ–¹åˆ¶å‰‚ï¼Œç”¨äºæ€¥ã€æ…¢æ€§è‚ç‚ï¼Œç™½ç»†èƒå‡å°‘ç—‡ï¼Œè¡€å°æ¿å‡å°‘ç—‡åŠå†ç”Ÿéšœç¢æ€§è´«è¡€ç­‰çš„è¾…åŠ©æ²»ç–—`,
        importance: 5,
      },
    ],
  },
  'C9.4': {
    sectionCode: 'C9.4',
    sectionTitle: 'ç¬¬å››èŠ‚ Î²-å†…é…°èƒºé…¶æŠ‘åˆ¶å‰‚åŠå…¶ä¸Î²-å†…é…°èƒºç±»æŠ—ç”Ÿç´ é…ä¼çš„å¤æ–¹åˆ¶å‰‚',
    currentPoints: 1,
    newPoints: [
      {
        title: 'Î²-å†…é…°èƒºé…¶æŠ‘åˆ¶å‰‚çš„åˆ†ç±»ä¸ä½œç”¨æœºåˆ¶',
        content: `åˆ†ç±»ï¼š
1. Î²-å†…é…°èƒºç¯ç»“æ„çš„ä¸å¯é€†æŠ‘åˆ¶å‰‚
   ä»£è¡¨è¯å“ï¼šå…‹æ‹‰ç»´é…¸ã€èˆ’å·´å¦ã€ä»–å”‘å·´å¦

2. éÎ²-å†…é…°èƒºç»“æ„çš„å¯é€†æŠ‘åˆ¶å‰‚ï¼ˆæ–°ä¸€ä»£é…¶æŠ‘åˆ¶å‰‚ï¼‰
   ä»£è¡¨è¯å“ï¼šé˜¿ç»´å·´å¦ã€é›·åˆ©å·´å¦ã€æ³•ç¡¼å·´å¦

ä½œç”¨æœºåˆ¶ï¼š
1. å…‹æ‹‰ç»´é…¸ã€èˆ’å·´å¦å’Œä»–å”‘å·´å¦ä¸ºÎ²-å†…é…°èƒºç¯ç»“æ„çš„ä¸å¯é€†çš„Î²-å†…é…°èƒºé…¶æŠ‘åˆ¶å‰‚ï¼›å¯¹é™¤ç¢³é’éœ‰çƒ¯é…¶å¤–çš„å¤§éƒ¨åˆ†Aç±»Î²-å†…é…°èƒºé…¶æœ‰æŠ‘åˆ¶ä½œç”¨ï¼›æŠ‘é…¶æ´»æ€§æ¯”è¾ƒï¼šä»–å”‘å·´å¦>å…‹æ‹‰ç»´é…¸>èˆ’å·´å¦

2. é˜¿ç»´å·´å¦ã€é›·åˆ©å·´å¦ã€æ³•ç¡¼å·´å¦ï¼ˆæ–°ä¸€ä»£é…¶æŠ‘åˆ¶å‰‚ï¼‰æ˜¯éÎ²-å†…é…°èƒºç»“æ„çš„å¯é€†çš„Î²-å†…é…°èƒºé…¶æŠ‘åˆ¶å‰‚ï¼Œå…·æœ‰æ›´å¹¿è°±çš„Î²-å†…é…°èƒºé…¶æŠ‘åˆ¶ä½œç”¨ï¼Œå¯¹åŒ…æ‹¬ç¢³é’éœ‰çƒ¯é…¶åœ¨å†…çš„Aç±»ã€Cç±»Î²-å†…é…°èƒºé…¶æœ‰æŠ‘åˆ¶ä½œç”¨

3. æ­¤ç±»è¯å‡ä¸èƒ½æŠ‘åˆ¶Bç±»é‡‘å±ç¢³é’éœ‰çƒ¯é…¶

4. å¤´å­¢ä»–å•¶é˜¿ç»´å·´å¦å¯¹å¤§éƒ¨åˆ†äº§ç¢³é’éœ‰çƒ¯é…¶çš„ç»†èŒæœ‰æŠ—èŒæ´»æ€§ï¼›èˆ’å·´å¦å’Œä»–å”‘å·´å¦èƒ½æŠ‘åˆ¶å¤šç§æ‹Ÿæ†èŒçš„æŸ“è‰²ä½“ä»‹å¯¼Î²-å†…é…°èƒºé…¶ï¼Œå› æ­¤å«æœ‰è¿™ç±»é…¶æŠ‘åˆ¶å‰‚çš„å¤æ–¹åˆ¶å‰‚å¯¹æ‹Ÿæ†èŒæœ‰æ´»æ€§`,
        importance: 5,
      },
      {
        title: 'å¤æ–¹åˆ¶å‰‚çš„ä¸´åºŠç”¨è¯è¯„ä»·',
        content: `å¸¸ç”¨å¤æ–¹åˆ¶å‰‚ï¼š
1. é˜¿è«è¥¿æ—/å…‹æ‹‰ç»´é…¸
2. æ°¨è‹„è¥¿æ—/èˆ’å·´å¦
3. å“Œæ‹‰è¥¿æ—/ä»–å”‘å·´å¦
4. å¤´å­¢å“Œé…®/èˆ’å·´å¦
5. å¤´å­¢ä»–å•¶/é˜¿ç»´å·´å¦

é€‚åº”è¯ï¼š
1. äº§Î²-å†…é…°èƒºé…¶ç»†èŒå¼•èµ·çš„æ„ŸæŸ“
2. å¤šé‡è€è¯èŒæ„ŸæŸ“
3. æ··åˆæ„ŸæŸ“

æ³¨æ„äº‹é¡¹ï¼š
1. å¤æ–¹åˆ¶å‰‚ä¸­çš„é…¶æŠ‘åˆ¶å‰‚æœ¬èº«æŠ—èŒæ´»æ€§è¾ƒå¼±ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¿æŠ¤Î²-å†…é…°èƒºç±»æŠ—ç”Ÿç´ ä¸è¢«é…¶æ°´è§£
2. åº”æ ¹æ®æ„ŸæŸ“éƒ¨ä½ã€ä¸¥é‡ç¨‹åº¦å’Œç—…åŸèŒé€‰æ‹©é€‚å½“çš„å¤æ–¹åˆ¶å‰‚
3. æ³¨æ„è¯ç‰©è¿‡æ•ååº”ï¼Œç‰¹åˆ«æ˜¯å¯¹Î²-å†…é…°èƒºç±»æŠ—ç”Ÿç´ è¿‡æ•è€…`,
        importance: 4,
      },
    ],
  },
  'C11.1': {
    sectionCode: 'C11.1',
    sectionTitle: 'ç¬¬ä¸€èŠ‚ ç³–ç±»ã€ç›ç±»ã€é…¸ç¢±å¹³è¡¡è°ƒèŠ‚è¯',
    currentPoints: 1,
    newPoints: [
      {
        title: 'é—¨å†¬æ°¨é…¸é’¾é•çš„ä¸´åºŠç”¨è¯è¯„ä»·',
        content: `ä½œç”¨ç‰¹ç‚¹ï¼š
1. é—¨å†¬æ°¨é…¸é’¾é•æ˜¯é—¨å†¬æ°¨é…¸é’¾ç›å’Œé•ç›çš„æ··åˆç‰©
2. é—¨å†¬æ°¨é…¸ä½œä¸ºè½½ä½“ï¼Œä½¿é’¾ç¦»å­ã€é•ç¦»å­æ˜“äºè¿›å…¥ç»†èƒå†…ï¼Œæé«˜ç»†èƒå†…é’¾ã€é•æµ“åº¦
3. å‚ä¸ç»†èƒå†…çš„ä¸‰ç¾§é…¸å¾ªç¯ï¼Œæ”¹å–„å¿ƒè‚Œèƒ½é‡ä»£è°¢

é€‚åº”è¯ï¼š
1. ä½é’¾è¡€ç—‡
2. ä½é•è¡€ç—‡
3. æ´‹åœ°é»„ä¸­æ¯’å¼•èµ·çš„å¿ƒå¾‹å¤±å¸¸
4. å¿ƒè‚Œç‚åé—ç—‡ã€æ…¢æ€§å¿ƒåŠŸèƒ½ä¸å…¨
5. æ€¥ã€æ…¢æ€§è‚ç‚çš„è¾…åŠ©æ²»ç–—

å…¸å‹ä¸è‰¯ååº”ï¼š
1. é«˜é’¾è¡€ç—‡ï¼šè¡€é’¾æµ“åº¦è¿‡é«˜
2. é«˜é•è¡€ç—‡ï¼šè¡€é•æµ“åº¦è¿‡é«˜
3. èƒƒè‚ é“ååº”ï¼šæ¶å¿ƒã€å‘•åã€è…¹æ³»

æ³¨æ„äº‹é¡¹ï¼š
1. é«˜é’¾è¡€ç—‡ã€é«˜é•è¡€ç—‡ã€ä¸¥é‡è‚¾åŠŸèƒ½ä¸å…¨è€…ç¦ç”¨
2. é™è„‰æ»´æ³¨é€Ÿåº¦ä¸å®œè¿‡å¿«ï¼Œé¿å…å¼•èµ·é«˜é’¾è¡€ç—‡æˆ–é«˜é•è¡€ç—‡
3. å®šæœŸç›‘æµ‹è¡€é’¾ã€è¡€é•æµ“åº¦`,
        importance: 4,
      },
      {
        title: 'å…¶ä»–ç›ç±»è°ƒèŠ‚è¯çš„ä¸´åºŠç”¨è¯è¯„ä»·',
        content: `æ°¯åŒ–é’™ï¼š
1. é€‚åº”è¯ï¼šä½é’™è¡€ç—‡ã€é«˜é’¾è¡€ç—‡ã€é«˜é•è¡€ç—‡ã€é’™é€šé“é˜»æ»å‰‚ä¸­æ¯’
2. å¯ç”¨äºè§£æ•‘é•ç›ä¸­æ¯’
3. é™è„‰æ³¨å°„å¯å¼•èµ·å±€éƒ¨å‰§çƒˆç–¼ç—›ï¼Œä¸”æœ‰å¿ƒè„åœæçš„å±é™©

æ°¯åŒ–é’¾ï¼š
1. é€‚åº”è¯ï¼šä½é’¾è¡€ç—‡ã€ä½é’¾æ€§å‘¨æœŸæ€§éº»ç—¹ã€æ´‹åœ°é»„ä¸­æ¯’
2. é™è„‰æ»´æ³¨å¯å¼•èµ·å±€éƒ¨å‰§çƒˆç–¼ç—›ï¼Œä¸”æœ‰å¿ƒè„åœæçš„å±é™©
3. é™è„‰è¡¥é’¾çš„æµ“åº¦åŠæ»´é€Ÿä¸å®œè¶…è¿‡ï¼š40mmol/L, 750mg/h

ä¹³é…¸é’ ï¼š
1. ç”¨äºçº æ­£ä»£è°¢æ€§é…¸ä¸­æ¯’
2. è‚åŠŸèƒ½ä¸å…¨è€…æ…ç”¨

ç¢³é…¸æ°¢é’ ï¼š
1. ç”¨äºçº æ­£ä»£è°¢æ€§é…¸ä¸­æ¯’
2. ç”¨äºç¢±åŒ–å°¿æ¶²ï¼Œä¿ƒè¿›æŸäº›è¯ç‰©æ’æ³„`,
        importance: 4,
      },
    ],
  },
}

async function updateSections() {
  console.log('ğŸ” æ£€æŸ¥å¹¶æ›´æ–°æŒ‡å®šç« èŠ‚çš„å°èŠ‚å†…å®¹...\n')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n')
  
  let totalUpdated = 0
  let totalSkipped = 0
  
  for (const [key, sectionData] of Object.entries(sectionsToUpdate)) {
    console.log(`\nğŸ“‹ å¤„ç†: ${sectionData.sectionCode} - ${sectionData.sectionTitle}`)
    
    // è·å–å°èŠ‚ID
    const { data: section } = await supabase
      .from('knowledge_tree')
      .select('id, code, title')
      .eq('subject_code', subjectCode)
      .eq('node_type', 'section')
      .eq('code', sectionData.sectionCode)
      .single()
    
    if (!section) {
      console.log(`   âŒ æœªæ‰¾åˆ°å°èŠ‚ ${sectionData.sectionCode}`)
      continue
    }
    
    console.log(`   âœ… å°èŠ‚ID: ${section.id}`)
    
    // æ£€æŸ¥å½“å‰è€ƒç‚¹
    const { data: currentPoints } = await supabase
      .from('knowledge_tree')
      .select('id, code, title')
      .eq('subject_code', subjectCode)
      .eq('node_type', 'point')
      .eq('parent_id', section.id)
    
    const currentCount = currentPoints?.length || 0
    console.log(`   ğŸ“Š å½“å‰è€ƒç‚¹æ•°: ${currentCount}`)
    console.log(`   ğŸ“„ å‡†å¤‡æ–°å¢è€ƒç‚¹æ•°: ${sectionData.newPoints.length}`)
    
    if (sectionData.newPoints.length === 0) {
      console.log(`   âš ï¸  æ²¡æœ‰æ–°è€ƒç‚¹éœ€è¦å¯¼å…¥`)
      totalSkipped++
      continue
    }
    
    // è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼å¹¶å¯¼å…¥
    const dbRecords = sectionData.newPoints.map((point, index) => {
      const pointIndex = currentCount + index + 1
      const pointCode = `${sectionData.sectionCode}.${pointIndex}`
      const pointId = `xiyao_er_${pointCode.replace(/\./g, '_').replace(/C/g, '')}`
      
      return {
        id: pointId,
        code: pointCode,
        title: point.title,
        content: point.content || null,
        node_type: 'point',
        point_type: null,
        drug_name: null,
        importance: point.importance || 3,
        importance_level: point.importance || 3,
        learn_mode: 'BOTH',
        error_pattern_tags: [],
        memory_tips: null,
        parent_id: section.id,
        subject_code: subjectCode,
        level: 3,
        sort_order: pointIndex,
      }
    })
    
    // å¯¼å…¥
    const { error } = await supabase
      .from('knowledge_tree')
      .upsert(dbRecords, { onConflict: 'id' })
    
    if (error) {
      console.error(`   âŒ å¯¼å…¥å¤±è´¥:`, error.message)
    } else {
      console.log(`   âœ… æˆåŠŸå¯¼å…¥ ${dbRecords.length} ä¸ªæ–°è€ƒç‚¹:`)
      dbRecords.forEach((record, idx) => {
        console.log(`      ${idx + 1}. ${record.code} - ${record.title}`)
      })
      totalUpdated += dbRecords.length
    }
  }
  
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log(`\nğŸ“Š æ›´æ–°å®Œæˆ:`)
  console.log(`   æ–°å¢è€ƒç‚¹: ${totalUpdated} ä¸ª`)
  console.log(`   è·³è¿‡å°èŠ‚: ${totalSkipped} ä¸ª`)
  console.log('\nâœ… æ›´æ–°å®Œæˆ!\n')
}

updateSections()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('âŒ æ›´æ–°å¤±è´¥:', error)
    process.exit(1)
  })

