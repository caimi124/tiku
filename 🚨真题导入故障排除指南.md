# 🚨 真题导入故障排除指南

## ❌ 错误：duplicate key value violates unique constraint

### 错误信息
```
ERROR: 23505: duplicate key value violates unique constraint "questions_pkey"
DETAIL: Key (id)=(2024_zyyz_001) already exists.
```

### 原因分析
这个错误表示：
- ✅ 数据库连接正常
- ✅ SQL语法正确
- ❌ **题目ID已存在**（之前已导入过）

PostgreSQL的主键（Primary Key）必须唯一，不能插入重复的ID。

---

## 🔧 解决方案（3种方法）

### 方案1：使用安全导入脚本（最简单）⭐⭐⭐

**优点：** 自动跳过已存在的题目，不会报错

**步骤：**
1. 打开文件：`⚡导入2024真题-安全版.sql`
2. 复制全部内容
3. 粘贴到 Supabase SQL Editor
4. 点击 Run 执行
5. ✅ 完成！自动处理冲突

**原理：**
```sql
INSERT INTO questions (...)
VALUES (...)
ON CONFLICT (id) DO NOTHING;  -- 🔥 关键：遇到冲突跳过
```

---

### 方案2：先清除后导入（最干净）⭐⭐

**优点：** 确保数据是最新的

**步骤：**

#### 第1步：清除旧数据
```sql
-- 打开文件：清除并重新导入2024真题.sql
DELETE FROM questions
WHERE source_year = 2024 
  AND subject = '中药学综合知识与技能';
```

#### 第2步：导入新数据
```sql
-- 打开文件：⚡导入2024真题-快速脚本.sql
-- 或：⚡导入2024真题-安全版.sql
```

---

### 方案3：检查并更新（适合修改数据）⭐

**优点：** 可以更新已存在的题目

**使用场景：**
- 修正错误答案
- 更新解析内容
- 添加知识点标签

**SQL模板：**
```sql
INSERT INTO questions (id, ...) 
VALUES ('2024_zyyz_001', ...)
ON CONFLICT (id) 
DO UPDATE SET
  content = EXCLUDED.content,
  correct_answer = EXCLUDED.correct_answer,
  explanation = EXCLUDED.explanation;
```

---

## 🔍 诊断工具

### 检查当前状态

运行诊断脚本：
```bash
文件：🔍检查数据库真题状态.sql
```

**输出示例：**
```
年份统计:
年份   题目数   章节数
2024   50      10
2023   20      8

2024年真题详情:
总数: 50
单选题: 45
多选题: 5
```

### 查找重复题目

```sql
-- 检查是否有重复ID
SELECT id, COUNT(*) as 出现次数
FROM questions
GROUP BY id
HAVING COUNT(*) > 1;
```

**预期结果：** 应该返回空（无重复）

### 查看具体题目

```sql
-- 查看某道题的详细信息
SELECT * FROM questions 
WHERE id = '2024_zyyz_001';
```

---

## 📋 常见问题 FAQ

### Q1: 为什么会出现重复ID？

**A:** 可能的原因：
1. **多次导入** - 之前已导入过，再次导入
2. **脚本重复执行** - 不小心运行了多次
3. **数据残留** - 测试数据未清理

### Q2: 如何知道哪些题目已导入？

**A:** 运行查询：
```sql
SELECT id, content, source_year
FROM questions
WHERE source_year = 2024
ORDER BY id;
```

### Q3: 可以修改已导入的题目吗？

**A:** 可以，使用UPDATE语句：
```sql
UPDATE questions
SET 
  content = '新的题目内容',
  correct_answer = 'B',
  explanation = '新的解析'
WHERE id = '2024_zyyz_001';
```

### Q4: 导入后发现答案错误怎么办？

**A:** 更正单个题目：
```sql
UPDATE questions
SET 
  correct_answer = '正确答案',
  explanation = '更正后的解析'
WHERE id = '题目ID';
```

### Q5: 如何删除某一年的所有题目？

**A:** 谨慎执行：
```sql
-- ⚠️ 警告：此操作不可恢复！
DELETE FROM questions
WHERE source_year = 2024;

-- 验证删除结果
SELECT COUNT(*) FROM questions WHERE source_year = 2024;
```

### Q6: 导入时部分题目失败怎么办？

**A:** 
1. 记录失败的题目ID
2. 使用安全导入脚本单独导入失败的题目
3. 或手动在Table Editor中添加

---

## 🎯 最佳实践

### 1. 导入前

**检查清单：**
- [ ] 数据库连接正常
- [ ] 确认要导入的年份
- [ ] 检查是否已存在数据
- [ ] 备份重要数据（可选）

**命令：**
```sql
-- 检查是否已有该年份数据
SELECT COUNT(*) FROM questions WHERE source_year = 2024;
```

### 2. 导入时

**推荐做法：**
- ✅ 使用"安全版"导入脚本
- ✅ 小批量导入（如每次30题）
- ✅ 导入后立即验证

**避免：**
- ❌ 重复执行同一脚本
- ❌ 一次性导入过多数据
- ❌ 不检查导入结果

### 3. 导入后

**验证步骤：**
```sql
-- 1. 检查数量
SELECT COUNT(*) FROM questions WHERE source_year = 2024;

-- 2. 检查题型分布
SELECT question_type, COUNT(*) 
FROM questions 
WHERE source_year = 2024 
GROUP BY question_type;

-- 3. 查看示例题目
SELECT id, LEFT(content, 50) as 题目, correct_answer
FROM questions 
WHERE source_year = 2024 
LIMIT 5;
```

---

## 🔄 标准导入流程

### 步骤1：环境检查
```sql
-- 文件：🔍检查数据库真题状态.sql
```

### 步骤2：决定策略

**情况A：首次导入**
→ 直接使用任何导入脚本

**情况B：已有数据，想重新导入**
→ 使用"清除并重新导入"

**情况C：已有数据，想补充新题**
→ 使用"安全版"导入脚本

### 步骤3：执行导入
```sql
-- 推荐：⚡导入2024真题-安全版.sql
```

### 步骤4：验证结果
```sql
-- 检查导入数量
SELECT source_year, COUNT(*) 
FROM questions 
GROUP BY source_year;
```

---

## 🛠️ 工具脚本汇总

| 脚本名称 | 用途 | 推荐度 |
|---------|------|--------|
| `⚡导入2024真题-安全版.sql` | 智能导入，自动处理冲突 | ⭐⭐⭐ |
| `清除并重新导入2024真题.sql` | 清除旧数据后重新导入 | ⭐⭐⭐ |
| `🔍检查数据库真题状态.sql` | 诊断当前数据库状态 | ⭐⭐⭐ |
| `⚡导入2024真题-快速脚本.sql` | 原始导入脚本 | ⭐⭐ |
| `数据库更新-添加历年真题字段.sql` | 更新表结构 | ⭐⭐ |

---

## 💡 快速解决

### 如果你只想快速解决问题

**执行这个：**
```sql
-- 方案：使用安全版导入（推荐）
-- 文件：⚡导入2024真题-安全版.sql
-- 特点：不会报错，自动跳过已存在的题目
```

**或者这个：**
```sql
-- 方案：先删除再导入
-- 第1步：清除2024年数据
DELETE FROM questions WHERE source_year = 2024;

-- 第2步：执行原始导入脚本
-- 文件：⚡导入2024真题-快速脚本.sql
```

---

## 📞 还是解决不了？

### 检查清单

- [ ] 数据库连接是否正常？
  ```bash
  npx tsx test-db-connection.ts
  ```

- [ ] SQL语法是否正确？
  - 检查是否有中文标点
  - 检查引号是否匹配

- [ ] questions表是否存在？
  ```sql
  SELECT * FROM questions LIMIT 1;
  ```

- [ ] 权限是否足够？
  - 在Supabase Dashboard中操作（推荐）

### 手动排查

1. **查看错误详情**
   - 复制完整错误信息
   - 注意错误中的ID

2. **查询该ID是否存在**
   ```sql
   SELECT * FROM questions WHERE id = '错误中的ID';
   ```

3. **决定处理方式**
   - 删除后重新插入
   - 或更新现有数据
   - 或使用新ID

---

## ✅ 成功标志

导入成功后你会看到：

```
✅ 导入完成！
题库总数: 120 道
2024年真题: 50 道
```

然后可以在前端访问：
```
http://localhost:3000/practice/history
```

---

## 🎯 总结

**核心原则：**
1. 数据库主键必须唯一
2. 重复导入会报错
3. 使用"安全版"脚本避免错误

**推荐方案：**
- 🥇 使用"安全版"导入脚本
- 🥈 先清除后导入
- 🥉 手动检查后处理

**预防措施：**
- 导入前先检查
- 使用事务包装（可选）
- 小批量逐步导入

---

**🎉 现在你知道如何处理导入冲突了！**

选择最适合你的方案，开始导入吧！
