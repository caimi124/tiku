# ğŸš¨ å›¾ç‰‡æ•°æ®ç¼ºå¤±é—®é¢˜ - å®Œæ•´åˆ†æ

## ğŸ” é—®é¢˜ç¡®è®¤

ç”¨æˆ·åé¦ˆï¼š**æ¸…é™¤ç¼“å­˜åä¾ç„¶çœ‹ä¸åˆ°å›¾ç‰‡**

è¿™è¯´æ˜ä¸æ˜¯ç¼“å­˜é—®é¢˜ï¼Œè€Œæ˜¯**æ•°æ®æ ¹æœ¬ä¸åœ¨æ•°æ®åº“ä¸­**ï¼

---

## ğŸ“Š é—®é¢˜åˆ†æ

### æ¶æ„è¯´æ˜

```
æœ¬åœ°å¼€å‘ç¯å¢ƒ (localhost:3000)
  â†“
  è¿æ¥ .env.localä¸­çš„DATABASE_URL
  â†“
  Supabaseç”Ÿäº§æ•°æ®åº“
  (db.tparjdkxxtnentsdazfw.supabase.co:5432)

ç”Ÿäº§ç¯å¢ƒ (Vercel)
  â†“  
  è¿æ¥ç¯å¢ƒå˜é‡ä¸­çš„DATABASE_URL
  â†“
  Supabaseç”Ÿäº§æ•°æ®åº“
  (åŒä¸€ä¸ªæ•°æ®åº“)
```

### å…³é”®å‘ç°

**æœ¬åœ°å’Œç”Ÿäº§ç¯å¢ƒè¿æ¥çš„æ˜¯åŒä¸€ä¸ªSupabaseæ•°æ®åº“ï¼**

è¿™æ„å‘³ç€ï¼š
1. âœ… ä¸å­˜åœ¨"æœ¬åœ°æœ‰æ•°æ®ã€ç”Ÿäº§æ²¡æ•°æ®"çš„é—®é¢˜
2. âœ… ä¸¤ä¸ªç¯å¢ƒçœ‹åˆ°çš„æ•°æ®æ˜¯å®Œå…¨ä¸€æ ·çš„
3. âŒ å¦‚æœå‰ç«¯çœ‹ä¸åˆ°å›¾ç‰‡ï¼Œè¯´æ˜Supabaseæ•°æ®åº“ä¸­ç¡®å®æ²¡æœ‰å›¾ç‰‡æ•°æ®

---

## ğŸ”´ æ ¹æœ¬åŸå› ï¼ˆ3ç§å¯èƒ½ï¼‰

### å¯èƒ½1ï¼šå¯¼å…¥æ—¶æ²¡æœ‰åŒ…å«å›¾ç‰‡æ•°æ®

æ£€æŸ¥å¯¼å…¥è„šæœ¬æ˜¯å¦æ­£ç¡®è®¾ç½®äº†`ai_explanation`å­—æ®µï¼š

```typescript
// prisma/import-2023-zhongyao-yaoxue-yiyao-FIXED.ts ç¬¬390è¡Œ
ai_explanation: imageData.length > 0 ? JSON.stringify({ images: imageData }) : null,
```

**é—®é¢˜**ï¼šå¯¼å…¥æ—¶å¯èƒ½å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯¼è‡´`imageData.length = 0`ï¼Œ`ai_explanation`è¢«è®¾ç½®ä¸º`null`

### å¯èƒ½2ï¼šå¯¼å…¥è„šæœ¬è¿è¡Œå¤±è´¥

æ£€æŸ¥å¯¼å…¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰`ğŸ“·Ã—5`è¿™æ ·çš„æ ‡è®°ï¼š

```
âœ… [37/120] Q37 å›¾ç¤ºè¯æä¸ºä¸‰æ£±çš„æ˜¯ ... âœ“5é€‰é¡¹ ğŸ“·Ã—5
```

å¦‚æœæ²¡æœ‰`ğŸ“·Ã—5`ï¼Œè¯´æ˜å¯¼å…¥æ—¶æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶ã€‚

### å¯èƒ½3ï¼šå›¾ç‰‡æ–‡ä»¶è·¯å¾„ä¸å¯¹

å¯¼å…¥è„šæœ¬ä¸­çš„å›¾ç‰‡ç›®å½•ï¼š
```typescript
const imageDir = path.join(__dirname, '../public/shuju/2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡/img');
```

**é—®é¢˜**ï¼šå¦‚æœå›¾ç‰‡ä¸åœ¨è¿™ä¸ªè·¯å¾„ï¼Œå°±æ‰¾ä¸åˆ°å›¾ç‰‡æ–‡ä»¶ã€‚

---

## âœ… éªŒè¯æ­¥éª¤

### ç¬¬1æ­¥ï¼šæ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
```powershell
cd E:\tiku
Get-ChildItem "public\shuju\2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡\img" | Select-Object -First 5 Name
```

é¢„æœŸè¾“å‡ºï¼š
```
37-A.jpeg
37-B.jpeg
37-C.jpeg
37-D.jpeg
37-E.jpeg
```

### ç¬¬2æ­¥ï¼šæŸ¥è¯¢æ•°æ®åº“éªŒè¯
```sql
SELECT 
  content,
  ai_explanation,
  created_at
FROM questions
WHERE exam_type = 'æ‰§ä¸šè¯å¸ˆ'
  AND subject = 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰'
  AND source_year = 2023
  AND content LIKE '%å›¾ç¤º%'
LIMIT 5;
```

å¦‚æœ`ai_explanation`åˆ—ä¸º`null`ï¼Œç¡®è®¤é—®é¢˜ï¼

### ç¬¬3æ­¥ï¼šæ£€æŸ¥å¯¼å…¥æ—¥å¿—

æŸ¥çœ‹ä¹‹å‰è¿è¡Œ`import-2023-zhongyao-yaoxue-yiyao-FIXED.ts`çš„æ—¥å¿—ï¼Œæœç´¢ï¼š
- `ğŸ“·Ã—5` - æœ‰å›¾ç‰‡
- `âœ“5é€‰é¡¹` - æ²¡æœ‰å›¾ç‰‡æ ‡è®°

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šé‡æ–°å¯¼å…¥æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰

**å‰ææ¡ä»¶**ï¼š
1. âœ… å›¾ç‰‡æ–‡ä»¶å­˜åœ¨äº`public/shuju/2023å¹´.../img/`
2. âœ… å¯¼å…¥è„šæœ¬å·²æ­£ç¡®é…ç½®å›¾ç‰‡è·¯å¾„

**æ‰§è¡Œæ­¥éª¤**ï¼š

```bash
# 1. ç¡®è®¤å›¾ç‰‡æ–‡ä»¶å­˜åœ¨
ls public/shuju/2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡/img/ | head -10

# 2. è¿è¡Œå¯¼å…¥è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨åˆ é™¤æ—§æ•°æ®ï¼‰
npx tsx prisma/import-2023-zhongyao-yaoxue-yiyao-FIXED.ts

# 3. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤æœ‰ ğŸ“·Ã—5 æ ‡è®°
# ä¾‹å¦‚ï¼šâœ… [37/120] Q37 å›¾ç¤ºè¯æä¸ºä¸‰æ£±çš„æ˜¯ ... âœ“5é€‰é¡¹ ğŸ“·Ã—5

# 4. éªŒè¯æ•°æ®åº“
npx tsx check-actual-options.ts
```

### æ–¹æ¡ˆBï¼šå•ç‹¬æ›´æ–°å›¾ç‰‡æ•°æ®

å¦‚æœä¸æƒ³é‡æ–°å¯¼å…¥æ‰€æœ‰é¢˜ç›®ï¼Œå¯ä»¥åªæ›´æ–°å›¾ç‰‡æ•°æ®ï¼š

```typescript
// update-image-data.ts
import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';
import * as path from 'path';

const prisma = new PrismaClient();

async function updateImages() {
  const imageDir = path.join(__dirname, 'public/shuju/2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡/img');
  
  // è·å–æ‰€æœ‰å›¾ç¤ºé¢˜
  const questions = await prisma.questions.findMany({
    where: {
      exam_type: 'æ‰§ä¸šè¯å¸ˆ',
      subject: 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰',
      source_year: 2023,
      content: { contains: 'å›¾ç¤º' }
    }
  });

  console.log(`æ‰¾åˆ° ${questions.length} é“å›¾ç¤ºé¢˜\n`);

  for (const q of questions) {
    // æ ¹æ®é¢˜ç›®å†…å®¹æ¨æ–­é¢˜å·ï¼ˆéœ€è¦å®ç°å…·ä½“é€»è¾‘ï¼‰
    const questionNumber = extractQuestionNumber(q.content);
    
    // æŸ¥æ‰¾å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶
    const imageFiles = ['A', 'B', 'C', 'D', 'E'].map(letter => {
      const filename = `${questionNumber}-${letter}.jpeg`;
      const filepath = path.join(imageDir, filename);
      if (fs.existsSync(filepath)) {
        return `/shuju/2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡/img/${filename}`;
      }
      return null;
    }).filter(Boolean);

    if (imageFiles.length > 0) {
      await prisma.questions.update({
        where: { id: q.id },
        data: {
          ai_explanation: JSON.stringify({ images: imageFiles })
        }
      });
      console.log(`âœ… æ›´æ–°é¢˜${questionNumber}ï¼Œ${imageFiles.length}å¼ å›¾ç‰‡`);
    }
  }

  await prisma.$disconnect();
}

updateImages();
```

---

## ğŸ“‹ å¯¼å…¥æ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œå¯¼å…¥è„šæœ¬å‰ï¼Œå¿…é¡»ç¡®è®¤ï¼š

```
â–¡ å›¾ç‰‡æ–‡ä»¶å­˜åœ¨äº public/shuju/2023å¹´.../img/
â–¡ å›¾ç‰‡å‘½åæ ¼å¼æ­£ç¡®ï¼š37-A.jpeg, 37-B.jpegç­‰
â–¡ å¯¼å…¥è„šæœ¬ä¸­çš„å›¾ç‰‡ç›®å½•è·¯å¾„æ­£ç¡®
â–¡ DATABASE_URLæŒ‡å‘æ­£ç¡®çš„æ•°æ®åº“
â–¡ æœ‰è¶³å¤Ÿçš„æ•°æ®åº“æƒé™
```

è¿è¡Œå¯¼å…¥åï¼Œå¿…é¡»éªŒè¯ï¼š

```
â–¡ å¯¼å…¥æ—¥å¿—ä¸­æœ‰ ğŸ“·Ã—5 æ ‡è®°
â–¡ æ•°æ®åº“ä¸­ai_explanationå­—æ®µä¸ä¸ºnull
â–¡ å‰ç«¯èƒ½æ­£ç¡®è§£æJSONæ•°æ®
â–¡ å›¾ç‰‡URLå¯ä»¥è®¿é—®
```

---

## ğŸ¯ æœ€å¯èƒ½çš„æƒ…å†µ

**åˆ†æ**ï¼š

1. ä½ ä¹‹å‰æˆåŠŸå¯¼å…¥äº†120é“é¢˜âœ…
2. é¢˜ç›®å†…å®¹ã€é€‰é¡¹éƒ½æ­£ç¡®âœ…
3. ä½†æ˜¯å›¾ç‰‡æ•°æ®(`ai_explanation`)ä¸ºç©ºâŒ

**åŸå› **ï¼šå¯¼å…¥æ—¶å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„ä¸å¯¹

**è¯æ®**ï¼š
- é¢„è§ˆæ—¶èƒ½çœ‹åˆ°å›¾ç‰‡ â†’ æŒ‡çš„æ˜¯çœ‹åˆ°å›¾ç‰‡æ–‡ä»¶å­˜åœ¨
- ä½†å‰ç«¯çœ‹ä¸åˆ° â†’ å› ä¸ºæ•°æ®åº“ä¸­æ²¡æœ‰å›¾ç‰‡URL

**è§£å†³**ï¼šé‡æ–°è¿è¡Œå¯¼å…¥è„šæœ¬ï¼Œç¡®ä¿å›¾ç‰‡æ–‡ä»¶å­˜åœ¨

---

## ğŸš€ ç«‹å³æ‰§è¡Œ

### ç¬¬1æ­¥ï¼šç¡®è®¤å›¾ç‰‡æ–‡ä»¶
```bash
cd E:\tiku
dir "public\shuju\2023å¹´æ‰§ä¸šè¯å¸ˆä¸­è¯è¯ä¸€å†å¹´çœŸé¢˜å›¾ç‰‡\img\37-*.jpeg"
```

åº”è¯¥çœ‹åˆ°5ä¸ªæ–‡ä»¶ï¼ˆ37-A.jpegåˆ°37-E.jpegï¼‰

### ç¬¬2æ­¥ï¼šé‡æ–°å¯¼å…¥ï¼ˆå¦‚æœå›¾ç‰‡å­˜åœ¨ï¼‰
```bash
npx tsx prisma/import-2023-zhongyao-yaoxue-yiyao-FIXED.ts
```

è§‚å¯Ÿæ—¥å¿—ï¼Œå¿…é¡»çœ‹åˆ°`ğŸ“·Ã—5`

### ç¬¬3æ­¥ï¼šéªŒè¯æ•°æ®åº“
```bash
npx tsx check-actual-options.ts
```

åº”è¯¥çœ‹åˆ°ï¼š
```
ai_explanation: {"images":[...]}
å›¾ç‰‡æ•°é‡: 5
```

### ç¬¬4æ­¥ï¼šåˆ·æ–°å‰ç«¯
```
Ctrl + F5
```

---

## ğŸ’¡ é¢„é˜²æªæ–½

### å¯¼å…¥æ—¶è‡ªåŠ¨éªŒè¯
åœ¨å¯¼å…¥è„šæœ¬æœ«å°¾æ·»åŠ ï¼š

```typescript
console.log('\n\nğŸ” éªŒè¯å¯¼å…¥ç»“æœ...\n');

const imageQuestionsCount = await prisma.questions.count({
  where: {
    exam_type: 'æ‰§ä¸šè¯å¸ˆ',
    subject: 'ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰',
    source_year: 2023,
    ai_explanation: { not: null }
  }
});

console.log(`âœ… ${imageQuestionsCount} é“é¢˜æœ‰å›¾ç‰‡æ•°æ®`);

if (imageQuestionsCount === 0) {
  console.log('âŒ è­¦å‘Šï¼šæ²¡æœ‰é¢˜ç›®æœ‰å›¾ç‰‡æ•°æ®ï¼');
  console.log('è¯·æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº:', imageDir);
}
```

---

## ğŸ“Š é—®é¢˜ç¡®è®¤æ–¹æ³•

å¦‚æœè¿˜ä¸ç¡®å®šï¼Œåœ¨æµè§ˆå™¨Consoleè¿è¡Œï¼š

```javascript
// è·å–ç¬¬ä¸€é“é¢˜
fetch('/api/questions?sourceYear=2023&subject=ä¸­è¯å­¦ä¸“ä¸šçŸ¥è¯†ï¼ˆä¸€ï¼‰&limit=1')
  .then(r => r.json())
  .then(data => {
    const q = data.data.questions[0];
    console.log('é¢˜ç›®:', q.content.substring(0, 30));
    console.log('aiExplanation:', q.aiExplanation);
    
    if (!q.aiExplanation) {
      console.log('âŒ ç¡®è®¤ï¼šæ•°æ®åº“ä¸­æ²¡æœ‰å›¾ç‰‡æ•°æ®ï¼');
    } else {
      console.log('âœ… æ•°æ®åº“æœ‰å›¾ç‰‡æ•°æ®');
      const parsed = JSON.parse(q.aiExplanation);
      console.log('å›¾ç‰‡æ•°é‡:', parsed.images.length);
      console.log('ç¬¬ä¸€å¼ :', parsed.images[0]);
    }
  });
```

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**99%ç¡®å®š**ï¼šSupabaseæ•°æ®åº“ä¸­çš„2023å¹´é¢˜ç›®æ²¡æœ‰`ai_explanation`æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°è¿è¡Œå¯¼å…¥è„šæœ¬ï¼Œç¡®ä¿ï¼š
1. å›¾ç‰‡æ–‡ä»¶å­˜åœ¨
2. å¯¼å…¥æ—¥å¿—æœ‰ğŸ“·æ ‡è®°
3. éªŒè¯ai_explanationä¸ä¸ºnull

æ‰§è¡Œåå‰ç«¯å°±èƒ½çœ‹åˆ°å›¾ç‰‡äº†ï¼
