# 🚨 历年真题显示"暂无相关资料"问题修复

## 📋 问题原因

您点击历年真题后显示"暂无相关资料"的原因是：
1. ❌ **数据库中没有导入真题数据**
2. ❌ **sourceYear 字段未设置或字段不存在**

---

## ✅ 完整修复步骤（3步，5分钟）

### 第1步：更新数据库结构（1分钟）

**打开 Supabase Dashboard SQL Editor:**
```
https://supabase.com/dashboard/project/tparjdkxxtnentsdazfw
```

**执行以下SQL（添加必要字段）:**

```sql
-- 添加历年真题必需字段
ALTER TABLE questions 
ADD COLUMN IF NOT EXISTS source_type TEXT,
ADD COLUMN IF NOT EXISTS source_year INTEGER;

-- 创建索引提高查询速度
CREATE INDEX IF NOT EXISTS idx_questions_source_year 
ON questions(source_year);

-- 验证字段已添加
SELECT 
  column_name, 
  data_type 
FROM information_schema.columns 
WHERE table_name = 'questions' 
  AND column_name IN ('source_type', 'source_year');

-- 显示成功消息
DO $$
BEGIN
  RAISE NOTICE '✅ 数据库结构更新成功！';
  RAISE NOTICE '可以开始导入真题数据了。';
END $$;
```

✅ 看到"数据库结构更新成功"即可进入下一步。

---

### 第2步：导入2024年真题（2分钟）

**在同一个 SQL Editor 中，新建查询并执行：**

```sql
-- ========================================
-- 2024年执业药师真题导入（安全版）
-- ========================================

-- 导入前先清除可能存在的旧数据
DELETE FROM questions 
WHERE source_year = 2024 
  AND subject = '中药学综合知识与技能';

-- 开始导入（示例：前10题）
INSERT INTO questions (
  id, exam_type, subject, chapter, question_type, 
  content, options, correct_answer, explanation, 
  difficulty, knowledge_points, source_type, source_year, is_published
) VALUES

-- 第1题
('2024_zyyz_001', '执业药师', '中药学综合知识与技能', '中医基础理论', 'single', 
'属于"阳脉之海"的是', 
'[{"key":"A","value":"阳维之脉"},{"key":"B","value":"阳跷之脉"},{"key":"C","value":"督脉"},{"key":"D","value":"带脉"},{"key":"E","value":"任脉"}]'::jsonb,
'C', '督脉为"阳脉之海"。任脉为"阴脉之海"。', 
2, ARRAY['经络学说', '高频考点', '2024年真题'], '真题', 2024, true),

-- 第2题
('2024_zyyz_002', '执业药师', '中药学综合知识与技能', '中药贮藏与养护', 'single',
'《中国药典》"凡例"中贮藏项下各名词术语进行了解释，关于中药贮藏名词说法，正确的是',
'[{"key":"A","value":"密封系指将容器密闭，以防止尘及异物进入"},{"key":"B","value":"遮光系指避免日光直射"},{"key":"C","value":"阴凉处系指不超过20°C的环境"},{"key":"D","value":"冷处系指0~8°C的环境"},{"key":"E","value":"常温系指10~25°C的环境"}]'::jsonb,
'C', '阴凉处系指不超过20°C的环境。', 
2, ARRAY['中药贮藏', '药典', '2024年真题'], '真题', 2024, true),

-- 第3题
('2024_zyyz_003', '执业药师', '中药学综合知识与技能', '中医诊断', 'single',
'舌苔黄腻，多见于',
'[{"key":"A","value":"寒湿证"},{"key":"B","value":"湿热证"},{"key":"C","value":"痰饮证"},{"key":"D","value":"血瘀证"},{"key":"E","value":"气滞证"}]'::jsonb,
'B', '舌苔黄腻，多见于湿热证。', 
2, ARRAY['舌诊', '望诊', '2024年真题'], '真题', 2024, true),

-- 第4题
('2024_zyyz_004', '执业药师', '中药学综合知识与技能', '中药注射剂使用', 'single',
'关于中药注射剂临床使用原则的说法，错误的是',
'[{"key":"A","value":"能口服给药的，不选用注射给药"},{"key":"B","value":"能肌内注射给药的，不选用静脉注射或滴注给药"},{"key":"C","value":"能单独使用的，不与其他药品混合使用"},{"key":"D","value":"应先做皮试，无过敏反应方可使用"},{"key":"E","value":"严格按照药品说明书规定的功能主治使用"}]'::jsonb,
'D', '中药注射剂一般不需要皮试。', 
3, ARRAY['中药注射剂', '用药安全', '2024年真题'], '真题', 2024, true),

-- 第5题
('2024_zyyz_005', '执业药师', '中药学综合知识与技能', '感冒用药', 'single',
'某男，28岁。恶寒重，发热轻，无汗，头痛，肢体酸痛，鼻塞流清涕，咳嗽痰白清稀。治疗宜选用的中成药是',
'[{"key":"A","value":"桑菊感冒颗粒"},{"key":"B","value":"双黄连口服液"},{"key":"C","value":"感冒清热颗粒"},{"key":"D","value":"银翘解毒片"},{"key":"E","value":"羚翘解毒丸"}]'::jsonb,
'C', '辨证为风寒感冒，治疗宜选用感冒清热颗粒。', 
2, ARRAY['感冒', '辨证施治', '2024年真题'], '真题', 2024, true),

-- 第6题
('2024_zyyz_006', '执业药师', '中药学综合知识与技能', '中药饮片炮制', 'single',
'处方开具"炒白术"，应调配',
'[{"key":"A","value":"生白术"},{"key":"B","value":"土炒白术"},{"key":"C","value":"麸炒白术"},{"key":"D","value":"焦白术"},{"key":"E","value":"白术炭"}]'::jsonb,
'C', '处方直接写"炒某药"，一般调配麸炒品。', 
3, ARRAY['中药炮制', '饮片调剂', '2024年真题'], '真题', 2024, true),

-- 第7题
('2024_zyyz_007', '执业药师', '中药学综合知识与技能', '中西药联用', 'single',
'关于中西药联用的说法，错误的是',
'[{"key":"A","value":"含麻黄的中成药不宜与降压药联用"},{"key":"B","value":"含甘草的中成药不宜与强心苷类药联用"},{"key":"C","value":"含鞣质的中药不宜与抗生素联用"},{"key":"D","value":"含钙的中成药可与四环素类抗生素联用"},{"key":"E","value":"含有机酸的中药不宜与碱性西药联用"}]'::jsonb,
'D', '含钙的中成药不宜与四环素类抗生素联用。', 
3, ARRAY['中西药联用', '用药安全', '2024年真题'], '真题', 2024, true),

-- 第8题
('2024_zyyz_008', '执业药师', '中药学综合知识与技能', '中成药', 'single',
'某女，35岁。月经量少，色淡，质稀，小腹隐痛，头晕眼花，心悸失眠，面色萎黄，舌淡苔薄，脉细。治疗宜选用的中成药是',
'[{"key":"A","value":"当归丸"},{"key":"B","value":"益母草颗粒"},{"key":"C","value":"调经活血片"},{"key":"D","value":"八珍益母丸"},{"key":"E","value":"逍遥丸"}]'::jsonb,
'D', '辨证为气血两虚证，治疗宜选用八珍益母丸。', 
3, ARRAY['月经病', '辨证施治', '2024年真题'], '真题', 2024, true),

-- 第9题
('2024_zyyz_009', '执业药师', '中药学综合知识与技能', '合理用药', 'single',
'某女，60岁。患有高血压病，规律服用缬沙坦，血压控制良好。近日因咽喉肿痛自购六神丸服用，服药后出现心律失常。最可能的原因是',
'[{"key":"A","value":"六神丸与缬沙坦发生药物相互作用"},{"key":"B","value":"六神丸中的蟾酥引起心脏毒性"},{"key":"C","value":"缬沙坦引起低钾血症导致心律失常"},{"key":"D","value":"患者对六神丸过敏"},{"key":"E","value":"六神丸加重高血压引起心律失常"}]'::jsonb,
'B', '六神丸含有蟾酥，蟾酥有强心作用，但过量或久服可引起心律失常。', 
4, ARRAY['用药安全', '毒性药物', '2024年真题'], '真题', 2024, true),

-- 第10题
('2024_zyyz_010', '执业药师', '中药学综合知识与技能', '中医诊断', 'single',
'患者面色淡白，唇舌色淡，多见于',
'[{"key":"A","value":"气虚证"},{"key":"B","value":"血虚证"},{"key":"C","value":"阳虚证"},{"key":"D","value":"阴虚证"},{"key":"E","value":"血瘀证"}]'::jsonb,
'B', '面色淡白或萎黄，唇舌色淡，多见于血虚证。', 
2, ARRAY['望诊', '面色', '2024年真题'], '真题', 2024, true);

-- 验证导入结果
SELECT 
  '✅ 导入完成' as 状态,
  COUNT(*) as 已导入题数,
  source_year as 年份
FROM questions
WHERE source_year = 2024
GROUP BY source_year;
```

✅ 看到"已导入题数: 10"即表示成功。

---

### 第3步：验证功能（30秒）

**在浏览器中测试：**

1. 访问：`http://localhost:3000/practice`
2. 点击"历年真题"卡片
3. 应该看到"2024年真题 - 10道题"
4. 点击"开始练习"按钮
5. 应该能看到题目了！

---

## 🔍 快速诊断脚本

如果还是有问题，运行以下SQL诊断：

```sql
-- 1. 检查字段是否存在
SELECT 
  column_name, 
  data_type,
  is_nullable
FROM information_schema.columns 
WHERE table_name = 'questions' 
  AND column_name IN ('source_type', 'source_year', 'exam_type', 'subject');

-- 2. 检查2024年真题数量
SELECT 
  '2024年真题统计' as 说明,
  COUNT(*) as 总数,
  COUNT(*) FILTER (WHERE question_type = 'single') as 单选题
FROM questions
WHERE source_year = 2024;

-- 3. 查看前3道题
SELECT 
  id,
  LEFT(content, 40) || '...' as 题目内容,
  correct_answer as 答案,
  source_year as 年份
FROM questions
WHERE source_year = 2024
ORDER BY id
LIMIT 3;

-- 4. 检查API可能用到的所有年份
SELECT 
  source_year as 年份,
  COUNT(*) as 题目数
FROM questions
WHERE source_year IS NOT NULL
GROUP BY source_year
ORDER BY source_year DESC;
```

**预期输出：**
```
字段检查:
- source_type: text
- source_year: integer
- exam_type: text
- subject: text

2024年真题统计:
总数: 10
单选题: 10

题目示例:
2024_zyyz_001 | 属于"阳脉之海"的是... | C | 2024
```

---

## 📦 完整数据包（可选）

如果需要导入完整的50道或120道题，使用这些文件：

**50道题（推荐快速测试）:**
```
⚡导入2024真题-安全版.sql
```

**更多题目：**
- 打开文件查看完整SQL
- 复制到 Supabase SQL Editor
- 执行即可

---

## 🚨 常见错误排查

### 错误1: "column does not exist"
**原因：** source_year 字段不存在  
**解决：** 重新执行第1步的ALTER TABLE语句

### 错误2: "duplicate key value"
**原因：** 题目ID已存在  
**解决：** 先执行DELETE语句清除旧数据

### 错误3: 前端仍显示"暂无相关资料"
**原因：** 
- 数据未导入成功
- API请求失败
- 浏览器缓存

**解决：**
```bash
# 1. 验证数据库
SELECT COUNT(*) FROM questions WHERE source_year = 2024;

# 2. 测试API
curl "http://localhost:3000/api/questions?sourceYear=2024&limit=1"

# 3. 清除浏览器缓存
Ctrl + Shift + R (强制刷新)
```

---

## 🎯 验证清单

完成后检查：
- [ ] 数据库字段已添加（source_year, source_type）
- [ ] 2024年真题已导入（至少10题）
- [ ] 前端历年真题列表显示"2024年真题 - XX道题"
- [ ] 点击"开始练习"能看到题目
- [ ] 能选择答案并查看解析

---

## 📞 仍然有问题？

### 检查开发服务器

```bash
# 确保服务器正在运行
npm run dev

# 查看控制台是否有错误
```

### 检查浏览器控制台

1. 按F12打开开发者工具
2. 查看Console标签页
3. 查看Network标签页
4. 找到 `/api/questions?sourceYear=2024` 请求
5. 查看返回数据

---

## ✅ 成功标志

修复成功后你会看到：

**历年真题列表页：**
```
📚 历年真题

[2024] 2024年真题
📄 10道题  未开始
[开始练习] [模拟考试]

[2023] 2023年真题
📄 0道题  敬请期待
```

**答题页面：**
```
2024年真题练习  1/10

1. 属于"阳脉之海"的是
○ A. 阳维之脉
○ B. 阳跷之脉
○ C. 督脉
○ D. 带脉
○ E. 任脉

[提交答案]
```

---

**🎉 按照以上步骤操作，5分钟内即可解决问题！**
